<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Pro ğŸŒ å…±æ—…ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Invite Overlay Pattern */
        .invite-pattern {
            background-color: #4f46e5;
            background-image: radial-gradient(#6366f1 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#6366f1', secondary: '#ec4899' }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col w-full max-w-md mx-auto bg-gray-50 shadow-2xl relative">

        <Transition name="fade">
            <div v-if="loading" class="absolute inset-0 z-[100] bg-white flex items-center justify-center">
                <div class="flex items-center gap-4 px-6 py-4 bg-white rounded-2xl">
                    <div class="w-10 h-10 rounded-full border-[4px] border-t-indigo-500 border-r-pink-500 border-b-yellow-500 border-l-blue-400 animate-spin"></div>
                    <span class="text-gray-600 font-bold tracking-widest text-lg">è¼‰å…¥ä¸­</span>
                </div>
            </div>
        </Transition>

        <div v-if="!user && !loading" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
            <div class="w-24 h-24 bg-gradient-to-tr from-primary to-purple-500 rounded-3xl flex items-center justify-center mb-6 shadow-xl transform rotate-3">
                <i class="fas fa-paper-plane text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Travel Pro å…±æ—…</h1>
            <p class="text-gray-500 mb-10">é‚€è«‹æœ‹å‹ä¸€èµ·è¦åŠƒè¡Œç¨‹èˆ‡è¨˜å¸³</p>
            
            <button @click="loginWithGoogle" class="flex items-center justify-center w-full bg-white border border-gray-300 rounded-xl py-3.5 px-4 shadow-sm hover:bg-gray-50 transition active:scale-95">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 mr-3" alt="Google">
                <span class="font-medium text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
            <p v-if="loginError" class="text-red-500 text-sm mt-4">{{ loginError }}</p>
        </div>

        <template v-else-if="user && !loading">
            
            <header class="bg-white px-5 py-3 shadow-sm z-10 flex justify-between items-center h-16 shrink-0">
                <div class="flex items-center gap-2">
                    <button v-if="currentView === 'planner'" @click="exitTrip" class="w-8 h-8 flex items-center justify-center -ml-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800 flex items-center">
                            <span v-if="currentView === 'dashboard'">æˆ‘çš„æ—…ç¨‹ ğŸ§³</span>
                            <span v-else>{{ currentTrip.destination || 'æœªå‘½åæ—…ç¨‹' }}</span>
                        </h1>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button v-if="currentView === 'planner'" @click="openTripSettings" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:text-primary hover:bg-indigo-50 flex items-center justify-center transition">
                        <i class="fas fa-cog"></i>
                    </button>

                    <button @click="showUserMenu = true" class="relative group focus:outline-none">
                        <img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" 
                             class="w-9 h-9 rounded-full border border-gray-200 transition transform active:scale-95 object-cover">
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto no-scrollbar p-4 relative bg-gray-50 flex flex-col">
                
                <div v-if="currentView === 'dashboard'" class="space-y-4 flex-1">
                    
                    <div v-if="trips.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸŒ</div>
                        <p>å°šç„¡æ—…ç¨‹</p>
                        <p class="text-xs mt-2">é»æ“Šå³ä¸‹è§’ã€Œ+ã€å»ºç«‹æˆ–ç­‰å¾…æœ‹å‹é‚€è«‹</p>
                    </div>

                    <div v-for="trip in trips" :key="trip.id" 
                         @click="enterTrip(trip)" 
                         class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition active:scale-[0.98] cursor-pointer relative overflow-hidden group">
                        
                        <div v-if="trip.isInvite" class="absolute inset-0 z-20 invite-pattern flex flex-col items-center justify-center text-white p-4" @click.stop>
                            <p class="font-bold text-lg mb-1">ğŸ“¬ æ”¶åˆ°æ—…ç¨‹é‚€è«‹</p>
                            <p class="text-sm opacity-80 mb-4">{{ trip.destination }} Â· {{ trip.ownerName || 'æœ‹å‹' }} é‚€è«‹æ‚¨</p>
                            <div class="flex gap-4">
                                <button @click="respondToInvite(trip, false)" class="w-12 h-12 rounded-full bg-white text-red-500 hover:bg-red-50 flex items-center justify-center shadow-lg transform transition hover:scale-110">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                                <button @click="respondToInvite(trip, true)" class="w-12 h-12 rounded-full bg-white text-green-500 hover:bg-green-50 flex items-center justify-center shadow-lg transform transition hover:scale-110">
                                    <i class="fas fa-check text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-xl font-bold text-gray-800">{{ trip.destination }}</h3>
                                    <span v-if="trip.isOwner" class="bg-indigo-100 text-indigo-600 text-[10px] px-1.5 py-0.5 rounded font-bold">åœ˜ä¸»</span>
                                </div>
                                <p v-if="trip.startDate" class="text-xs text-gray-400 mb-2 flex items-center">
                                    <i class="far fa-calendar-alt mr-1.5"></i> 
                                    {{ trip.startDate.replace(/-/g, '/') }} 
                                    <span v-if="trip.endDate" class="mx-1">~</span> 
                                    {{ trip.endDate ? trip.endDate.replace(/-/g, '/') : '' }}
                                </p>
                                <div class="flex -space-x-1.5 mt-2">
                                    <div v-for="(m, i) in (trip.members || []).slice(0, 5)" :key="i" 
                                         class="w-6 h-6 rounded-full border-2 border-white bg-gray-200 overflow-hidden" 
                                         :title="m.name">
                                        <img :src="m.photo || 'https://ui-avatars.com/api/?name='+m.name" class="w-full h-full object-cover">
                                    </div>
                                    <div v-if="(trip.members || []).length > 5" class="w-6 h-6 rounded-full border-2 border-white bg-gray-100 flex items-center justify-center text-[8px] text-gray-500">
                                        +{{ trip.members.length - 5 }}
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 mt-2"></i>
                        </div>
                    </div>

                    <div v-if="trips.filter(t => !t.isInvite).length > 0" class="mt-6 mb-20">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden">
                            <div class="absolute -right-6 -bottom-6 text-white/10 text-9xl"><i class="fas fa-plane-departure"></i></div>
                            <h3 class="text-sm font-bold opacity-90 mb-4 flex items-center"><i class="fas fa-passport mr-2"></i> æ—…éŠç”Ÿæ¶¯çµ±è¨ˆ</h3>
                            <div class="flex justify-between items-center relative z-10">
                                <div class="text-center"><p class="text-2xl font-bold">{{ userStats.totalTrips }}</p><p class="text-[10px] opacity-75">æ—…ç¨‹</p></div>
                                <div class="w-px h-8 bg-white/20"></div>
                                <div class="text-center"><p class="text-2xl font-bold">{{ userStats.totalDays }}</p><p class="text-[10px] opacity-75">å¤©æ•¸</p></div>
                                <div class="w-px h-8 bg-white/20"></div>
                                <div class="text-center"><p class="text-2xl font-bold">{{ userStats.uniquePlaces }}</p><p class="text-[10px] opacity-75">åœ°é»</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'planner'">
                    
                    <div v-if="activeTab === 'schedule'">
                        <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6 p-2">
                            <button v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                                :class="currentDayIndex === index ? 'bg-primary text-white shadow-lg shadow-indigo-200 ring-2 ring-primary ring-offset-1' : 'bg-white text-gray-500 border border-gray-100'"
                                class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium transition-all whitespace-nowrap">
                                Day {{ index + 1 }}
                            </button>
                        </div>

                        <div v-if="currentDayEvents.length > 0" class="space-y-4 pl-2 pb-20">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-6 border-l-2 border-gray-200 last:border-transparent pb-4 group">
                                <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm z-10"></div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-primary font-bold text-lg font-mono tracking-tight">{{ event.time }}</span>
                                        <div class="flex space-x-3 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="editEvent(event)" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                            <button @click="deleteItem('schedule', event.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-gray-800 text-lg mb-1">{{ event.title }}</h3>
                                    <div v-if="event.location" class="flex items-center text-gray-500 text-sm mb-2 cursor-pointer" @click="openMap(event.location)">
                                        <i class="fas fa-map-marker-alt mr-1.5 text-secondary"></i>
                                        <span class="truncate border-b border-dashed border-gray-300 hover:text-gray-700">{{ event.location }}</span>
                                    </div>
                                    <p v-if="event.note" class="text-gray-400 text-sm mt-2 pt-2 border-t border-gray-50 flex items-start">
                                        <i class="fas fa-info-circle mr-1.5 mt-0.5 opacity-50"></i> <span>{{ event.note }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ—“ï¸</div>
                            <p>Day {{ currentDayIndex + 1 }} é‚„æ˜¯ç©ºçš„</p>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'expense'" class="pb-20">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-xl shadow-gray-200/50 mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                            <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">ç¸½æ”¯å‡º</p>
                            <h2 class="text-4xl font-bold font-mono tracking-tight flex items-baseline">
                                <span class="text-xl mr-1">{{ currentTrip.currency || '$' }}</span>{{ totalExpense.toLocaleString() }}
                            </h2>
                            <div class="mt-6 flex justify-between items-end">
                                <div>
                                    <p class="text-gray-400 text-xs mb-1">å¹³å‡æ¯äºº</p>
                                    <p class="font-mono text-lg">{{ currentTrip.currency || '$' }} {{ averageExpense.toLocaleString() }}</p>
                                </div>
                                <div class="flex -space-x-2">
                                    <div v-for="(m, i) in (currentTrip.members || [])" :key="i" class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-800 overflow-hidden" :title="m.name">
                                        <img :src="m.photo || 'https://ui-avatars.com/api/?name='+m.name" class="w-full h-full object-cover">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="flex justify-between items-end mb-2">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">é ç®—ç‹€æ…‹</h3>
                                <button @click="openTripSettings" class="text-xs text-primary font-bold hover:underline">
                                    {{ currentTrip.budget > 0 ? 'èª¿æ•´' : 'è¨­å®šé ç®—' }}
                                </button>
                            </div>
                            <div v-if="currentTrip.budget > 0">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>å·²ç”¨ {{ Math.round(budgetPercentage) }}%</span>
                                    <span :class="remainingBudget < 0 ? 'text-red-500 font-bold' : ''">å‰©é¤˜ {{ currentTrip.currency }}{{ remainingBudget.toLocaleString() }}</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                    <div class="h-2.5 rounded-full transition-all duration-500" :class="budgetColor" :style="{ width: Math.min(budgetPercentage, 100) + '%' }"></div>
                                </div>
                            </div>
                            <div v-else class="text-center py-2">
                                <p class="text-xs text-gray-400 mb-2">å°šæœªè¨­å®šæ—…éŠé ç®—</p>
                                <button @click="openTripSettings" class="w-full py-2 bg-gray-50 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-100 border border-dashed border-gray-300">
                                    <i class="fas fa-plus-circle mr-1"></i> æ–°å¢é ç®—ä¸Šé™
                                </button>
                            </div>
                        </div>

                        <div v-if="debts.length > 0" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 text-sm mb-3 uppercase tracking-wide">çµç®—æ–¹æ¡ˆ</h3>
                            <div class="space-y-3">
                                <div v-for="(debt, idx) in debts" :key="idx" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex items-center text-sm">
                                        <span class="font-bold text-gray-700">{{ debt.from }}</span>
                                        <i class="fas fa-long-arrow-alt-right mx-2 text-gray-400"></i>
                                        <span class="font-bold text-gray-700">{{ debt.to }}</span>
                                    </div>
                                    <span class="font-mono font-bold text-secondary">{{ currentTrip.currency || '$' }}{{ debt.amount.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>

                        <div v-if="sortedExpenses.length > 0" class="space-y-3">
                            <div v-for="expense in sortedExpenses" :key="expense.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary font-bold text-sm shrink-0 overflow-hidden">
                                        {{ expense.payer ? expense.payer.charAt(0) : '?' }}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 leading-tight">{{ expense.title }}</p>
                                        <p class="text-xs text-gray-400 mt-0.5">{{ formatDate(expense.date) }} Â· {{ expense.payer }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold font-mono text-gray-800">{{ currentTrip.currency || '$' }}{{ parseInt(expense.amount).toLocaleString() }}</p>
                                    <button @click="deleteItem('expenses', expense.id)" class="text-gray-300 text-xs mt-1 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <button @click="onFabClick"
                class="absolute bottom-24 right-5 w-14 h-14 bg-gray-900 text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-xl hover:scale-105 active:scale-95 transition z-40">
                <i class="fas fa-plus"></i>
            </button>

            <Transition name="fade">
                <div v-if="showTripModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showTripModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">{{ currentTrip.id ? 'æ—…ç¨‹è¨­å®š' : 'å»ºç«‹æ–°æ—…ç¨‹' }}</h3>
                            <button @click="showTripModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ç›®çš„åœ°</label>
                                <div class="relative">
                                    <input readonly @click="showDestinationModal = true" v-model="tripForm.destination" type="text" placeholder="é»æ“Šé¸æ“‡" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary cursor-pointer pr-10">
                                    <i class="fas fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ—…éŠæ—¥æœŸ</label>
                                <div class="flex items-center gap-2">
                                    <input v-model="tripForm.startDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary text-sm">
                                    <span class="text-gray-400 font-bold">-</span>
                                    <input v-model="tripForm.endDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary text-sm">
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">è²¨å¹£</label>
                                    <input v-model="tripForm.currency" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary text-center">
                                </div>
                                <div class="flex-[2]">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">é ç®—ä¸Šé™</label>
                                    <input v-model.number="tripForm.budget" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ—…ä¼´</label>
                                <div class="flex flex-wrap gap-2 items-center">
                                    <div v-for="member in tripForm.members" :key="member.uid" class="relative group">
                                        <img :src="member.photo || 'https://ui-avatars.com/api/?name='+member.name" class="w-10 h-10 rounded-full border border-gray-200 object-cover" :title="member.name">
                                        <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5" v-if="member.uid === user.uid">
                                            <i class="fas fa-star text-[10px] text-yellow-400"></i>
                                        </div>
                                    </div>
                                    
                                    <div v-for="email in tripForm.pendingEmails" :key="email" class="relative w-10 h-10 rounded-full bg-gray-100 border border-dashed border-gray-300 flex items-center justify-center group" title="é‚€è«‹ä¸­">
                                        <span class="text-xs text-gray-400 font-bold">?</span>
                                        <button @click="cancelInvite(email)" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>
                                    </div>

                                    <button @click="showInviteModal = true" class="w-10 h-10 rounded-full bg-indigo-50 border border-indigo-200 text-indigo-500 flex items-center justify-center hover:bg-indigo-100 transition">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-2" v-if="tripForm.pendingEmails.length > 0">
                                    ç­‰å¾… {{ tripForm.pendingEmails.length }} ä½æœ‹å‹æ¥å—é‚€è«‹...
                                </p>
                            </div>
                        </div>
                        <button @click="saveTrip" class="w-full py-2.5 bg-gray-800 text-white rounded-xl hover:bg-gray-900 font-bold shadow-lg shadow-gray-200">
                            {{ currentTrip.id ? 'å„²å­˜è®Šæ›´' : 'å»ºç«‹æ—…ç¨‹' }}
                        </button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showInviteModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showInviteModal = false">
                    <div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">é‚€è«‹æœ‹å‹</h3>
                        <input v-model="inviteEmail" type="email" placeholder="æœ‹å‹çš„ Email" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary mb-4">
                        <div class="flex gap-3">
                            <button @click="showInviteModal = false" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold">å–æ¶ˆ</button>
                            <button @click="addInvite" class="flex-1 py-2 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-200">ç™¼é€</button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showDestinationModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showDestinationModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl mx-5 overflow-hidden flex flex-col max-h-[70vh]">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-800">é¸æ“‡ç›®çš„åœ°</h3>
                            <button @click="showDestinationModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex border-b border-gray-200">
                            <button v-for="key in Object.keys(regions)" :key="key" @click="activeRegion = key" :class="activeRegion === key ? 'border-primary text-primary bg-indigo-50' : 'border-transparent text-gray-500 hover:bg-gray-50'" class="flex-1 py-3 text-sm font-bold border-b-2 transition">{{ key }}</button>
                        </div>
                        <div class="p-4 overflow-y-auto grid grid-cols-2 gap-3 bg-gray-50/50 flex-1">
                            <button v-for="country in regions[activeRegion]" :key="country.name" @click="selectDestination(country)" class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-primary hover:shadow-md transition text-left flex items-center justify-between group">
                                <span class="font-medium text-gray-700 group-hover:text-primary">{{ country.name }}</span>
                                <span class="text-xs font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{{ country.currency }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="slide-up">
                <div v-if="showItemModal" class="absolute inset-0 z-50 flex items-end justify-center pointer-events-none">
                    <div class="bg-white w-full max-w-md rounded-t-3xl p-6 shadow-2xl pointer-events-auto border-t border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex gap-4">
                                <button @click="activeTab = 'schedule'; showItemModal = true" :class="activeTab === 'schedule' ? 'text-primary font-bold border-b-2 border-primary' : 'text-gray-400'" class="pb-1">è¡Œç¨‹</button>
                                <button @click="activeTab = 'expense'; showItemModal = true" :class="activeTab === 'expense' ? 'text-secondary font-bold border-b-2 border-secondary' : 'text-gray-400'" class="pb-1">æ”¯å‡º</button>
                            </div>
                            <button @click="showItemModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>

                        <div v-if="activeTab === 'schedule'" class="space-y-4">
                            <div class="flex gap-3">
                                <input v-model="form.time" type="time" class="bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary font-mono">
                                <input v-model="form.title" type="text" placeholder="è¡Œç¨‹åç¨± (å¿…å¡«)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary">
                            </div>
                            <div class="relative">
                                <i class="fas fa-map-marker-alt absolute left-4 top-4 text-gray-400"></i>
                                <input v-model="form.location" type="text" placeholder="åœ°é» / Google Maps é€£çµ" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 outline-none focus:border-primary">
                            </div>
                            <textarea v-model="form.note" placeholder="å‚™è¨»..." rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary resize-none"></textarea>
                        </div>

                        <div v-else class="space-y-4">
                            <input v-model="expenseForm.title" type="text" placeholder="æ”¯å‡ºé …ç›® (å¦‚: æ™šé¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-secondary">
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-gray-400 font-bold">{{ currentTrip.currency || '$' }}</span>
                                <input v-model="expenseForm.amount" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 outline-none focus:border-secondary font-mono text-lg">
                            </div>
                            <div class="flex gap-2 items-center overflow-x-auto no-scrollbar py-1">
                                <span class="text-xs text-gray-400 shrink-0">ä»˜æ¬¾äºº:</span>
                                <button v-for="m in (currentTrip.members || [])" :key="m.name" 
                                        @click="expenseForm.payer = m.name"
                                        :class="expenseForm.payer === m.name ? 'bg-secondary text-white shadow-md shadow-pink-200' : 'bg-gray-100 text-gray-600'"
                                        class="px-3 py-1.5 rounded-full text-xs font-bold transition whitespace-nowrap">
                                    {{ m.name }}
                                </button>
                            </div>
                        </div>

                        <button @click="submitItem" class="w-full mt-6 py-3 rounded-xl text-white font-bold shadow-lg active:scale-95 transition" :class="activeTab === 'schedule' ? 'bg-primary shadow-indigo-200' : 'bg-secondary shadow-pink-200'">
                            <span v-if="submitting"><i class="fas fa-spinner fa-spin"></i></span>
                            <span v-else>å„²å­˜</span>
                        </button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showUserMenu" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showUserMenu = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-end mb-2"><button @click="showUserMenu = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
                        <div class="flex flex-col items-center mb-6">
                             <img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" class="w-20 h-20 rounded-full border-4 border-gray-50 shadow-md mb-3 object-cover">
                             <h3 class="text-xl font-bold text-gray-800">{{ settings.displayName || user.displayName || 'ä½¿ç”¨è€…' }}</h3>
                             <p class="text-sm text-gray-400 font-mono">{{ user.email }}</p>
                             <div @click="copyUid" class="mt-2 flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full cursor-pointer hover:bg-gray-200 transition group">
                                <span class="text-[10px] font-mono text-gray-500 truncate max-w-[200px]">UID: {{ user.uid }}</span>
                                <i class="fas fa-copy text-xs text-gray-400 group-hover:text-primary"></i>
                             </div>
                             <p v-if="copyToast" class="text-xs text-green-500 font-bold mt-1 transition-all">{{ copyToast }}</p>
                        </div>
                        <div class="flex flex-col gap-3">
                            <button @click="openEditProfile" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-bold flex items-center justify-center gap-2"><i class="fas fa-edit"></i> ç·¨è¼¯æª”æ¡ˆ</button>
                            <button @click="confirmAction('logout')" class="w-full py-3 text-red-500 bg-red-50 border border-red-100 rounded-xl hover:bg-red-100 font-bold flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºå¸³è™Ÿ</button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showConfirmModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showConfirmModal = false">
                    <div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5 text-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fas fa-exclamation-triangle"></i></div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªæ“ä½œ</h3>
                        <p class="text-sm text-gray-500 mb-6">{{ confirmMessage }}</p>
                        <div class="flex gap-3">
                            <button @click="showConfirmModal = false" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                            <button @click="executeConfirm" class="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-200">ç¢ºå®š</button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showErrorModal" class="absolute inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showErrorModal = false">
                    <div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5 text-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fas fa-exclamation"></i></div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">æç¤º</h3>
                        <p class="text-sm text-gray-500 mb-6">{{ errorMessage }}</p>
                        <button @click="showErrorModal = false" class="w-full py-2.5 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900 shadow-lg">ç¢ºå®š</button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showProfileModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showProfileModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3>
                            <button @click="showProfileModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å§“å / æš±ç¨±</label><input v-model="profileForm.displayName" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é ­è²¼é€£çµ (URL)</label><input v-model="profileForm.photoURL" type="text" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div>
                        </div>
                         <button @click="saveProfile" class="w-full py-2.5 bg-primary text-white rounded-xl hover:bg-indigo-600 font-bold shadow-lg shadow-indigo-200">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </Transition>

        </template>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch, where, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = {
            apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, 
            authDomain: "travel-fa395.firebaseapp.com",
            projectId: "travel-fa395",
            storageBucket: "travel-fa395.firebasestorage.app",
            messagingSenderId: "837385103808",
            appId: "1:837385103808:web:f998a17e4aeccf4b7f8025",
            measurementId: "G-31D354GWVR"
        };
        const app = initializeApp(userConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app'; // Namespace

        const { createApp, ref, computed, watch, onMounted } = window.Vue;

        const regions = {
            'æ±': [{ name: 'æ—¥æœ¬', currency: 'Â¥' }, { name: 'éŸ“åœ‹', currency: 'â‚©' }, { name: 'å°ç£', currency: 'NT$' }, { name: 'é¦™æ¸¯', currency: 'HK$' }, { name: 'ä¸­åœ‹', currency: 'Â¥' }],
            'å—': [{ name: 'æ³°åœ‹', currency: 'à¸¿' }, { name: 'è¶Šå—', currency: 'â‚«' }, { name: 'æ–°åŠ å¡', currency: 'S$' }, { name: 'é¦¬ä¾†è¥¿äº', currency: 'RM' }, { name: 'è²å¾‹è³“', currency: 'â‚±' }, { name: 'æ¾³æ´²', currency: 'A$' }],
            'è¥¿': [{ name: 'ç¾åœ‹', currency: '$' }, { name: 'è‹±åœ‹', currency: 'Â£' }, { name: 'æ­ç›Ÿ', currency: 'â‚¬' }, { name: 'åŠ æ‹¿å¤§', currency: 'C$' }],
            'åŒ—': [{ name: 'åŒ—æµ·é“', currency: 'Â¥' }, { name: 'ä¿„ç¾…æ–¯', currency: 'â‚½' }]
        };

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const loginError = ref('');
                
                // State
                const currentView = ref('dashboard');
                const trips = ref([]); // Combined list
                const currentTrip = ref({});
                const activeTab = ref('schedule');
                const days = ref([]);
                const currentDayIndex = ref(0);
                
                // Modals
                const showItemModal = ref(false);
                const showTripModal = ref(false);
                const showUserMenu = ref(false); 
                const showProfileModal = ref(false);
                const showDestinationModal = ref(false);
                const showInviteModal = ref(false); // New
                const showConfirmModal = ref(false);
                const showErrorModal = ref(false);
                
                // Messages & Actions
                const confirmMessage = ref('');
                const pendingAction = ref(null);
                const errorMessage = ref('');
                const copyToast = ref('');
                const inviteEmail = ref('');
                
                // Form Data
                const activeRegion = ref('æ±');
                const isEditing = ref(false);
                const submitting = ref(false);
                const currentEditId = ref(null);
                
                const schedule = ref([]);
                const expenses = ref([]);
                const settings = ref({});

                const profileForm = ref({ displayName: '', photoURL: '' });
                const tripForm = ref({ destination: '', currency: '', members: [], pendingEmails: [], startDate: '', endDate: '', budget: 0 });
                const form = ref({ time: '10:00', title: '', location: '', note: '' });
                const expenseForm = ref({ title: '', amount: '', payer: '' });

                // Listeners
                let unsubJoined = null;
                let unsubInvited = null;
                let unsubSchedule = null;
                let unsubExpenses = null;
                let unsubSettings = null;

                onMounted(() => {
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u) {
                            saveUserDirectory(u); // Sync profile
                            fetchGlobalData();
                        } else {
                            trips.value = [];
                            schedule.value = [];
                            expenses.value = [];
                        }
                    });
                });

                // --- 0. Core Logic: User Directory & Auth ---
                const saveUserDirectory = async (u) => {
                    // Update user's profile in a public collection so invites work
                    if(!u.email) return;
                    try {
                        const profileRef = doc(db, 'artifacts', appId, 'profiles', u.email);
                        await setDoc(profileRef, {
                            uid: u.uid,
                            email: u.email,
                            name: u.displayName || 'User',
                            photo: u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'User'}`
                        }, { merge: true });
                        
                        // Also sync legacy settings spot
                        const settingsRef = doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'config');
                        await setDoc(settingsRef, { displayName: u.displayName, photoURL: u.photoURL }, { merge: true });
                    } catch(e) { console.error("Profile sync failed", e); }
                };

                const loginWithGoogle = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (error) { loginError.value = "ç™»å…¥å¤±æ•—: " + error.message; }
                };

                // --- 1. Global Data: Listen to Shared Trips ---
                const fetchGlobalData = () => {
                    // Listen to Settings
                    unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config'), (docSnap) => {
                        if (docSnap.exists()) settings.value = docSnap.data();
                    });

                    // Listen to Trips: TWO Queries (Joined vs Invited)
                    const tripsRef = collection(db, 'artifacts', appId, 'trips');
                    
                    // Query 1: I am a member
                    const qJoined = query(tripsRef, where('memberUids', 'array-contains', user.value.uid));
                    unsubJoined = onSnapshot(qJoined, (snapshot) => {
                        updateTripsList('joined', snapshot.docs);
                    });

                    // Query 2: I am invited (by email)
                    if (user.value.email) {
                        const qInvited = query(tripsRef, where('pendingEmails', 'array-contains', user.value.email));
                        unsubInvited = onSnapshot(qInvited, (snapshot) => {
                            updateTripsList('invited', snapshot.docs);
                        });
                    }
                };

                // Merge Joined and Invited lists locally
                let tripsCache = { joined: [], invited: [] };
                const updateTripsList = (type, docs) => {
                    const parsed = docs.map(d => ({ 
                        id: d.id, ...d.data(), 
                        isInvite: type === 'invited',
                        isOwner: d.data().ownerId === user.value.uid,
                        ownerName: (d.data().members || []).find(m => m.uid === d.data().ownerId)?.name || 'æœ‰äºº'
                    }));
                    tripsCache[type] = parsed;
                    // Sort by start date desc
                    trips.value = [...tripsCache.joined, ...tripsCache.invited].sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                };

                // --- 2. Trip Actions & Invites ---
                const onFabClick = () => {
                    if (currentView.value === 'dashboard') {
                        // Create New Trip
                        tripForm.value = { 
                            destination: '', currency: 'Â¥', 
                            startDate: '', endDate: '', budget: 0,
                            members: [{ uid: user.value.uid, name: user.value.displayName || 'æˆ‘', photo: user.value.photoURL }],
                            pendingEmails: []
                        };
                        currentTrip.value = {}; 
                        showTripModal.value = true;
                    } else {
                        openAddItemModal();
                    }
                };

                const respondToInvite = async (trip, accept) => {
                    const tripRef = doc(db, 'artifacts', appId, 'trips', trip.id);
                    try {
                        const batch = writeBatch(db);
                        // Remove from pending
                        batch.update(tripRef, { pendingEmails: arrayRemove(user.value.email) });
                        
                        if (accept) {
                            // Add to members
                            const myProfile = {
                                uid: user.value.uid,
                                name: settings.value.displayName || user.value.displayName || 'User',
                                photo: settings.value.photoURL || user.value.photoURL
                            };
                            batch.update(tripRef, { 
                                memberUids: arrayUnion(user.value.uid),
                                members: arrayUnion(myProfile)
                            });
                        }
                        await batch.commit();
                    } catch (e) { showAlert("æ“ä½œå¤±æ•—: " + e.message); }
                };

                const addInvite = () => {
                    if(!inviteEmail.value || !inviteEmail.value.includes('@')) return showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email");
                    if(tripForm.value.pendingEmails.includes(inviteEmail.value)) return showAlert("å·²åœ¨é‚€è«‹åå–®ä¸­");
                    // Simply add string to local array, saveTrip handles DB
                    tripForm.value.pendingEmails.push(inviteEmail.value);
                    inviteEmail.value = '';
                    showInviteModal.value = false;
                };

                const cancelInvite = (email) => {
                    tripForm.value.pendingEmails = tripForm.value.pendingEmails.filter(e => e !== email);
                };

                const saveTrip = async () => {
                    if (!tripForm.value.destination) return showAlert('è«‹è¼¸å…¥ç›®çš„åœ°');
                    if (!tripForm.value.startDate || !tripForm.value.endDate) return showAlert('è«‹é¸æ“‡æ—…éŠæ—¥æœŸ');
                    
                    const newDays = calculateDays(tripForm.value.startDate, tripForm.value.endDate);
                    
                    const tripData = {
                        destination: tripForm.value.destination,
                        currency: tripForm.value.currency,
                        startDate: tripForm.value.startDate,
                        endDate: tripForm.value.endDate,
                        budget: tripForm.value.budget || 0,
                        members: tripForm.value.members, // Array of objects
                        memberUids: tripForm.value.members.map(m => m.uid), // Array of UIDs for querying
                        pendingEmails: tripForm.value.pendingEmails,
                        updatedAt: new Date().toISOString()
                    };

                    if (!currentTrip.value.id) {
                        tripData.ownerId = user.value.uid; // Set owner on create
                    }

                    const performSave = async () => {
                        try {
                            const tripsColl = collection(db, 'artifacts', appId, 'trips');
                            if (currentTrip.value.id) {
                                // Update logic...
                                if (newDays.length < days.value.length) {
                                     // Handle day reduction cleanup
                                     const eventsToDelete = schedule.value.filter(e => e.dayIndex >= newDays.length);
                                     if (eventsToDelete.length > 0) {
                                        const batch = writeBatch(db);
                                        const tripRef = doc(tripsColl, currentTrip.value.id);
                                        eventsToDelete.forEach(ev => batch.delete(doc(tripRef, 'schedule', ev.id)));
                                        await batch.commit();
                                     }
                                }
                                await updateDoc(doc(tripsColl, currentTrip.value.id), tripData);
                                currentTrip.value = { ...currentTrip.value, ...tripData };
                                days.value = newDays;
                            } else {
                                await addDoc(tripsColl, tripData);
                            }
                            showTripModal.value = false;
                        } catch (e) { showAlert("å„²å­˜å¤±æ•—: " + e.message); }
                    };

                    if (currentTrip.value.id && newDays.length < days.value.length && schedule.value.some(e => e.dayIndex >= newDays.length)) {
                        confirmAction('reduce_days', performSave);
                    } else {
                        performSave();
                    }
                };

                // --- 3. View Logic ---
                const enterTrip = (trip) => {
                    if (trip.isInvite) return; // Cant enter pending invites
                    currentTrip.value = trip;
                    currentView.value = 'planner';
                    activeTab.value = 'schedule';
                    days.value = calculateDays(trip.startDate, trip.endDate);
                    
                    const tripRef = doc(db, 'artifacts', appId, 'trips', trip.id);
                    unsubSchedule = onSnapshot(collection(tripRef, 'schedule'), s => schedule.value = s.docs.map(d => ({id:d.id, ...d.data()})));
                    unsubExpenses = onSnapshot(collection(tripRef, 'expenses'), s => expenses.value = s.docs.map(d => ({id:d.id, ...d.data()})));
                };

                const exitTrip = () => {
                    currentView.value = 'dashboard';
                    currentTrip.value = {};
                    schedule.value = []; expenses.value = [];
                    if (unsubSchedule) unsubSchedule();
                    if (unsubExpenses) unsubExpenses();
                };

                const openTripSettings = () => {
                    tripForm.value = {
                        destination: currentTrip.value.destination,
                        currency: currentTrip.value.currency,
                        members: currentTrip.value.members || [],
                        pendingEmails: currentTrip.value.pendingEmails || [],
                        startDate: currentTrip.value.startDate,
                        endDate: currentTrip.value.endDate,
                        budget: currentTrip.value.budget
                    };
                    showTripModal.value = true;
                };

                // --- 4. Sub-item Logic (Schedule/Expense) ---
                const openAddItemModal = () => {
                    isEditing.value = false; currentEditId.value = null;
                    form.value = { time: '09:00', title: '', location: '', note: '' };
                    // Default payer is me or first member
                    const meName = (currentTrip.value.members || []).find(m => m.uid === user.value.uid)?.name;
                    expenseForm.value = { title: '', amount: '', payer: meName || (currentTrip.value.members?.[0]?.name) || '' };
                    showItemModal.value = true;
                };

                const submitItem = async () => {
                    submitting.value = true;
                    const tripRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                    try {
                        if (activeTab.value === 'schedule') {
                            if (!form.value.title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                            const data = { ...form.value, dayIndex: currentDayIndex.value, updatedAt: new Date().toISOString() };
                            if (isEditing.value) await updateDoc(doc(tripRef, 'schedule', currentEditId.value), data);
                            else await addDoc(collection(tripRef, 'schedule'), data);
                        } else {
                            if (!expenseForm.value.title || !expenseForm.value.amount) throw new Error("è³‡æ–™ä¸å®Œæ•´");
                            await addDoc(collection(tripRef, 'expenses'), { ...expenseForm.value, date: new Date().toISOString() });
                        }
                        showItemModal.value = false;
                    } catch (e) { showAlert(e.message); } finally { submitting.value = false; }
                };
                
                const deleteItem = async (type, id) => {
                     // Using built-in confirm for simplicity inside item list
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'trips', currentTrip.value.id, type, id));
                    } catch (e) { showAlert("åˆªé™¤å¤±æ•—"); }
                };

                // --- Helpers ---
                const calculateDays = (s, e) => {
                    if (!s || !e) return ['Day 1'];
                    const diff = Math.abs(new Date(e) - new Date(s));
                    return Array.from({length: Math.ceil(diff / 86400000) + 1}, (_, i) => `Day ${i + 1}`);
                };
                const showAlert = (msg) => { errorMessage.value = msg; showErrorModal.value = true; };
                const confirmAction = (type, payload) => {
                    if (type === 'logout') { confirmMessage.value = 'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ'; pendingAction.value = async () => { await signOut(auth); showUserMenu.value = false; }; }
                    else if (type === 'reduce_days') { confirmMessage.value = 'ç¸®çŸ­è¡Œç¨‹å°‡æœƒåˆªé™¤å¤šé¤˜çš„è¡Œç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ'; pendingAction.value = payload; }
                    showConfirmModal.value = true;
                };
                const executeConfirm = async () => { if(pendingAction.value) await pendingAction.value(); showConfirmModal.value = false; };
                const selectDestination = (c) => { tripForm.value.destination = c.name; tripForm.value.currency = c.currency; showDestinationModal.value = false; };
                const openEditProfile = () => { profileForm.value = { displayName: settings.value.displayName || user.value.displayName, photoURL: settings.value.photoURL || user.value.photoURL }; showUserMenu.value = false; showProfileModal.value = true; };
                const saveProfile = async () => { 
                    try { 
                        await updateProfile(user.value, profileForm.value); 
                        await saveUserDirectory({ ...user.value, ...profileForm.value }); // Update DB too
                        showProfileModal.value = false; 
                    } catch(e) { showAlert(e.message); } 
                };
                const editEvent = (e) => { isEditing.value = true; currentEditId.value = e.id; form.value = {...e}; showItemModal.value = true; };
                const copyUid = () => { navigator.clipboard.writeText(user.value.uid); copyToast.value = 'å·²è¤‡è£½!'; setTimeout(()=>copyToast.value='',2000); };
                const formatDate = (iso) => { const d = new Date(iso); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
                const openMap = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');

                // --- Computeds ---
                const currentDayEvents = computed(() => schedule.value.filter(e => e.dayIndex === currentDayIndex.value));
                const sortedEvents = computed(() => [...currentDayEvents.value].sort((a,b) => a.time.localeCompare(b.time)));
                const sortedExpenses = computed(() => [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)));
                const totalExpense = computed(() => expenses.value.reduce((s,i) => s + (Number(i.amount)||0), 0));
                
                // Updated Logic for Member-based Stats
                const averageExpense = computed(() => {
                    const count = (currentTrip.value.members || []).length;
                    return count ? Math.round(totalExpense.value / count) : 0;
                });
                const budgetPercentage = computed(() => (currentTrip.value.budget > 0) ? (totalExpense.value / currentTrip.value.budget)*100 : 0);
                const remainingBudget = computed(() => (currentTrip.value.budget || 0) - totalExpense.value);
                const budgetColor = computed(() => budgetPercentage.value >= 100 ? 'bg-red-500' : budgetPercentage.value >= 80 ? 'bg-red-400' : budgetPercentage.value >= 50 ? 'bg-yellow-400' : 'bg-green-400');
                
                const debts = computed(() => {
                    const members = (currentTrip.value.members || []).map(m => m.name); // Extract names
                    if (members.length < 2) return [];
                    const bal = {}; members.forEach(m => bal[m]=0);
                    expenses.value.forEach(e => {
                        const amt = Number(e.amount);
                        if(members.includes(e.payer)) {
                            bal[e.payer] += amt;
                            members.forEach(m => bal[m] -= amt/members.length);
                        }
                    });
                    const d = [], c = [];
                    for(const [u,v] of Object.entries(bal)) {
                        if(v < -1) d.push({u,v});
                        if(v > 1) c.push({u,v});
                    }
                    d.sort((a,b)=>a.v-b.v); c.sort((a,b)=>b.v-a.v);
                    const res = []; let i=0, j=0;
                    while(i<d.length && j<c.length) {
                        const amt = Math.min(Math.abs(d[i].v), c[j].v);
                        res.push({from: d[i].u, to: c[j].u, amount: Math.round(amt)});
                        d[i].v += amt; c[j].v -= amt;
                        if(Math.abs(d[i].v)<1) i++; if(c[j].v<1) j++;
                    }
                    return res;
                });

                const userStats = computed(() => {
                    let td = 0; const pl = new Set();
                    trips.value.filter(t => !t.isInvite).forEach(t => {
                        if(t.startDate && t.endDate) td += Math.ceil(Math.abs(new Date(t.endDate)-new Date(t.startDate))/86400000)+1;
                        if(t.destination) pl.add(t.destination);
                    });
                    return { totalTrips: trips.value.filter(t => !t.isInvite).length, totalDays: td, uniquePlaces: pl.size };
                });

                return {
                    user, loading, loginError,
                    currentView, trips, currentTrip,
                    activeTab, days, currentDayIndex,
                    showItemModal, showTripModal, showUserMenu, showProfileModal, showDestinationModal, showInviteModal, showConfirmModal, showErrorModal,
                    confirmMessage, errorMessage, copyToast, inviteEmail,
                    activeRegion, regions, profileForm, tripForm, form, expenseForm,
                    schedule, expenses, settings,
                    currentDayEvents, sortedEvents, sortedExpenses, totalExpense, averageExpense, debts,
                    budgetPercentage, remainingBudget, budgetColor, userStats, isEditing, submitting,
                    loginWithGoogle, confirmAction, executeConfirm,
                    onFabClick, enterTrip, exitTrip, openTripSettings, saveTrip,
                    openAddItemModal, editEvent, submitItem, deleteItem,
                    openEditProfile, saveProfile, copyUid, selectDestination,
                    addInvite, cancelInvite, respondToInvite,
                    addDay: () => days.value.push(`Day ${days.value.length + 1}`),
                    openMap, formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
