<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Pro ğŸŒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col w-full max-w-md mx-auto bg-gray-50 shadow-2xl relative">

        <div v-if="!user" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
            <div class="w-24 h-24 bg-gradient-to-tr from-primary to-purple-500 rounded-3xl flex items-center justify-center mb-6 shadow-xl transform rotate-3">
                <i class="fas fa-globe-americas text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Travel Pro è‡ªç”±è¡Œ</h1>
            <p class="text-gray-500 mb-10">é›²ç«¯åŒæ­¥ä½ çš„è¡Œç¨‹èˆ‡å¸³å‹™</p>
            
            <button @click="loginWithGoogle" class="flex items-center justify-center w-full bg-white border border-gray-300 rounded-xl py-3.5 px-4 shadow-sm hover:bg-gray-50 transition active:scale-95">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 mr-3" alt="Google">
                <span class="font-medium text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
            <p v-if="loginError" class="text-red-500 text-sm mt-4">{{ loginError }}</p>
            
            <p class="mt-8 text-xs text-gray-400">
                æ³¨æ„ï¼šé¦–æ¬¡ä½¿ç”¨è«‹ç¢ºä¿å·²å•Ÿç”¨ Firebase Authentication
            </p>
        </div>

        <template v-else>
            <header class="bg-white px-5 py-3 shadow-sm z-10 flex justify-between items-center h-16">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 flex items-center">
                        {{ settings.destination || 'æˆ‘çš„æ—…ç¨‹' }} âœˆï¸
                        <span v-if="loading" class="ml-2 loader"></span>
                    </h1>
                    <p class="text-[10px] text-gray-500 font-mono">ID: {{ user.displayName || 'Traveler' }}</p>
                </div>
                
                <div class="flex items-center gap-3">
                    <button @click="showSettings = true" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:text-primary hover:bg-indigo-50 flex items-center justify-center transition">
                        <i class="fas fa-cog"></i>
                    </button>

                    <button @click="showUserMenu = true" class="relative group focus:outline-none">
                        <img :src="user.photoURL || 'https://ui-avatars.com/api/?name=User'" 
                             class="w-9 h-9 rounded-full border border-gray-200 transition transform active:scale-95 object-cover">
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative bg-gray-50">
                
                <div v-if="activeTab === 'schedule'">
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6 p-2">
                        <button 
                            v-for="(day, index) in days" 
                            :key="index"
                            @click="currentDayIndex = index"
                            :class="currentDayIndex === index ? 'bg-primary text-white shadow-lg shadow-indigo-200 ring-2 ring-primary ring-offset-1' : 'bg-white text-gray-500 border border-gray-100'"
                            class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium transition-all whitespace-nowrap">
                            Day {{ index + 1 }}
                        </button>
                        <button @click="addDay" class="flex-shrink-0 w-10 flex items-center justify-center rounded-xl bg-gray-200 text-gray-500 hover:bg-gray-300">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>

                    <div v-if="currentDayEvents.length > 0" class="space-y-4 pl-2">
                        <div v-for="event in sortedEvents" :key="event.id" class="relative pl-6 border-l-2 border-gray-200 last:border-transparent pb-4 group">
                            <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm z-10"></div>
                            
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-primary font-bold text-lg font-mono tracking-tight">{{ event.time }}</span>
                                    <div class="flex space-x-3 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click="editEvent(event)" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                        <button @click="deleteItem('schedule', event.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg mb-1">{{ event.title }}</h3>
                                
                                <div v-if="event.location" class="flex items-center text-gray-500 text-sm mb-2 cursor-pointer" @click="openMap(event.location)">
                                    <i class="fas fa-map-marker-alt mr-1.5 text-secondary"></i>
                                    <span class="truncate border-b border-dashed border-gray-300 hover:text-gray-700">{{ event.location }}</span>
                                </div>

                                <p v-if="event.note" class="text-gray-400 text-sm mt-2 pt-2 border-t border-gray-50 flex items-start">
                                    <i class="fas fa-info-circle mr-1.5 mt-0.5 opacity-50"></i> 
                                    <span>{{ event.note }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ—“ï¸</div>
                        <p>Day {{ currentDayIndex + 1 }} é‚„æ˜¯ç©ºçš„</p>
                        <p class="text-xs mt-2">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•é–‹å§‹è¦åŠƒ</p>
                    </div>
                </div>

                <div v-else-if="activeTab === 'expense'">
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-xl shadow-gray-200/50 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                        <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Total Expenses</p>
                        <h2 class="text-4xl font-bold font-mono tracking-tight flex items-baseline">
                            <span class="text-xl mr-1">{{ settings.currency || '$' }}</span>{{ totalExpense.toLocaleString() }}
                        </h2>
                        <div class="mt-6 flex justify-between items-end">
                            <div>
                                <p class="text-gray-400 text-xs mb-1">Average per person</p>
                                <p class="font-mono text-lg">{{ settings.currency || '$' }} {{ averageExpense.toLocaleString() }}</p>
                            </div>
                            <div class="flex -space-x-2">
                                <div v-for="(u, i) in settings.users" :key="i" class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-800 flex items-center justify-center text-xs font-bold text-gray-300">
                                    {{ u.charAt(0) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="debts.length > 0" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-700 text-sm mb-3 uppercase tracking-wide">çµç®—æ–¹æ¡ˆ</h3>
                        <div class="space-y-3">
                            <div v-for="(debt, idx) in debts" :key="idx" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                <div class="flex items-center text-sm">
                                    <span class="font-bold text-gray-700">{{ debt.from }}</span>
                                    <i class="fas fa-long-arrow-alt-right mx-2 text-gray-400"></i>
                                    <span class="font-bold text-gray-700">{{ debt.to }}</span>
                                </div>
                                <span class="font-mono font-bold text-secondary">{{ settings.currency || '$' }}{{ debt.amount.toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-3 px-1">
                        <h3 class="font-bold text-gray-700">æ”¯å‡ºæ˜ç´°</h3>
                        <span class="text-xs text-gray-400">{{ expenses.length }} ç­†è³‡æ–™</span>
                    </div>
                    
                    <div class="space-y-3 pb-20">
                        <div v-for="expense in sortedExpenses" :key="expense.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary font-bold text-sm shrink-0">
                                    {{ expense.payer ? expense.payer.charAt(0) : '?' }}
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800 leading-tight">{{ expense.title }}</p>
                                    <p class="text-xs text-gray-400 mt-0.5">{{ formatDate(expense.date) }} Â· {{ expense.payer }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold font-mono text-gray-800">{{ settings.currency || '$' }}{{ parseInt(expense.amount).toLocaleString() }}</p>
                                <button @click="deleteItem('expenses', expense.id)" class="text-gray-300 text-xs mt-1 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                            </div>
                        </div>
                        <div v-if="expenses.length === 0" class="text-center py-10 text-gray-400 text-sm italic">
                            è¨˜ä¸‹ç¬¬ä¸€ç­†èŠ±è²»å§ï¼ğŸ’°
                        </div>
                    </div>
                </div>

            </main>

            <button 
                @click="openAddModal"
                class="absolute bottom-24 right-5 w-14 h-14 bg-gray-900 text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-xl hover:scale-105 active:scale-95 transition z-40">
                <i class="fas fa-plus"></i>
            </button>

            <nav class="bg-white border-t border-gray-100 pb-safe pt-2 px-6 flex justify-between items-center z-30 pb-4 h-20 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
                <button 
                    @click="activeTab = 'schedule'" 
                    class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200"
                    :class="activeTab === 'schedule' ? 'text-primary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-map-marked-alt text-xl mb-0.5 transform transition" :class="activeTab === 'schedule' ? 'scale-110' : ''"></i>
                    <span class="text-[10px] font-bold tracking-wide">è¡Œç¨‹</span>
                </button>
                <div class="w-px h-8 bg-gray-100"></div>
                <button 
                    @click="activeTab = 'expense'" 
                    class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200"
                    :class="activeTab === 'expense' ? 'text-secondary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-wallet text-xl mb-0.5 transform transition" :class="activeTab === 'expense' ? 'scale-110' : ''"></i>
                    <span class="text-[10px] font-bold tracking-wide">åˆ†å¸³</span>
                </button>
            </nav>

            <Transition name="slide-up">
                <div v-if="showModal" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-[2px]" @click.self="closeModal">
                    <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[85vh] sm:h-auto flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">
                                {{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }} {{ activeTab === 'schedule' ? 'è¡Œç¨‹' : 'æ”¯å‡º' }}
                            </h3>
                            <button @click="closeModal" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto no-scrollbar space-y-5">
                            <div v-if="activeTab === 'schedule'" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ™‚é–“</label>
                                    <input v-model="form.time" type="time" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition text-lg font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ´»å‹•</label>
                                    <input v-model="form.title" type="text" placeholder="ä¾‹å¦‚ï¼šé€›å¤œå¸‚" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">åœ°é»</label>
                                    <div class="relative">
                                        <i class="fas fa-map-pin absolute left-4 top-4 text-gray-400"></i>
                                        <input v-model="form.location" type="text" placeholder="è¼¸å…¥ Google Maps é—œéµå­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-10 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å‚™è¨»</label>
                                    <textarea v-model="form.note" rows="3" placeholder="ç¥¨åˆ¸è³‡è¨Šã€é ç´„è™Ÿç¢¼..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition resize-none"></textarea>
                                </div>
                            </div>

                            <div v-if="activeTab === 'expense'" class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é‡‘é¡</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-3.5 text-gray-400 font-bold">{{ settings.currency || '$' }}</span>
                                        <input v-model.number="expenseForm.amount" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-8 outline-none focus:border-secondary focus:ring-2 focus:ring-secondary/20 transition text-2xl font-mono font-bold">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é …ç›®</label>
                                    <input v-model="expenseForm.title" type="text" placeholder="ä¾‹å¦‚ï¼šæ™šé¤" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-secondary focus:ring-2 focus:ring-secondary/20 transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä»˜æ¬¾äºº</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button 
                                            v-for="u in settings.users" 
                                            :key="u" 
                                            @click="expenseForm.payer = u"
                                            :class="expenseForm.payer === u ? 'bg-secondary text-white shadow-md shadow-pink-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                            class="py-2.5 rounded-lg text-sm font-medium transition">
                                            {{ u }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="submitForm" class="w-full mt-4 py-4 rounded-2xl text-white font-bold text-lg shadow-lg active:scale-[0.98] transition flex items-center justify-center" :class="activeTab === 'schedule' ? 'bg-primary shadow-indigo-200 hover:bg-indigo-600' : 'bg-secondary shadow-pink-200 hover:bg-pink-600'">
                            <span v-if="submitting" class="loader border-white border-t-transparent w-5 h-5 mr-2"></span>
                            {{ isEditing ? 'å„²å­˜è®Šæ›´' : 'ç¢ºèªæ–°å¢' }}
                        </button>
                    </div>
                </div>
            </Transition>

             <Transition name="fade">
                <div v-if="showSettings" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showSettings = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                        
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">æ—…ç¨‹è¨­å®š</h3>
                            <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">ç›®çš„åœ° (æ¨™é¡Œ)</label>
                                <input v-model="destinationInput" type="text" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€é¦–çˆ¾" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">è²¨å¹£ç¬¦è™Ÿ</label>
                                <div class="flex gap-2">
                                    <input v-model="currencyInput" type="text" placeholder="ä¾‹å¦‚ï¼šÂ¥, $, â‚©" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                                    <button @click="currencyInput='NT$'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">NT$</button>
                                    <button @click="currencyInput='Â¥'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">Â¥</button>
                                    <button @click="currencyInput='$'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">$</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                                <input v-model="settingsInput" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                            </div>
                        </div>

                        <button @click="saveSettings" class="w-full py-2.5 bg-gray-800 text-white rounded-xl hover:bg-gray-900 font-bold shadow-lg shadow-gray-200">å„²å­˜æ—…ç¨‹è¨­å®š</button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showUserMenu" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showUserMenu = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-end mb-2">
                            <button @click="showUserMenu = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>

                        <div class="flex flex-col items-center mb-6">
                             <img :src="user.photoURL || 'https://ui-avatars.com/api/?name=User'" class="w-20 h-20 rounded-full border-4 border-gray-50 shadow-md mb-3 object-cover">
                             <h3 class="text-xl font-bold text-gray-800">{{ user.displayName || 'ä½¿ç”¨è€…' }}</h3>
                             <p class="text-sm text-gray-400 font-mono">{{ user.email }}</p>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button @click="openEditProfile" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-edit"></i> ç·¨è¼¯æª”æ¡ˆ
                            </button>
                            <button @click="logout" class="w-full py-3 text-red-500 bg-red-50 border border-red-100 rounded-xl hover:bg-red-100 font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-sign-out-alt"></i> ç™»å‡ºå¸³è™Ÿ
                            </button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showProfileModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showProfileModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3>
                            <button @click="showProfileModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å§“å / æš±ç¨±</label>
                                <input v-model="profileForm.displayName" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é ­è²¼é€£çµ (URL)</label>
                                <input v-model="profileForm.photoURL" type="text" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                            </div>
                        </div>

                         <button @click="saveProfile" class="w-full py-2.5 bg-primary text-white rounded-xl hover:bg-indigo-600 font-bold shadow-lg shadow-indigo-200">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </Transition>

        </template>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ==========================================
        // Firebase è¨­å®šå€
        // ==========================================
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = {
            apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, 
            authDomain: "travel-fa395.firebaseapp.com",
            projectId: "travel-fa395",
            storageBucket: "travel-fa395.firebasestorage.app",
            messagingSenderId: "837385103808",
            appId: "1:837385103808:web:f998a17e4aeccf4b7f8025",
            measurementId: "G-31D354GWVR"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { createApp, ref, computed, watch, onMounted } = window.Vue;

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const loginError = ref('');
                
                const activeTab = ref('schedule');
                const showModal = ref(false);
                const showSettings = ref(false); 
                const showUserMenu = ref(false); 
                const showProfileModal = ref(false); // æ–°å¢ï¼šæ§åˆ¶ç·¨è¼¯æª”æ¡ˆè¦–çª—

                const isEditing = ref(false);
                const submitting = ref(false);
                
                const currentDayIndex = ref(0);
                const days = ref(['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']);
                
                const schedule = ref([]);
                const expenses = ref([]);
                
                // Settings Data
                const settings = ref({
                    users: ['æˆ‘', 'æ—…ä¼´A'],
                    destination: 'æ±äº¬',
                    currency: 'Â¥'
                });
                const settingsInput = ref('æˆ‘, æ—…ä¼´A');
                const destinationInput = ref('æ±äº¬');
                const currencyInput = ref('Â¥');

                // Profile Form
                const profileForm = ref({ displayName: '', photoURL: '' });

                const form = ref({ time: '10:00', title: '', location: '', note: '' });
                const expenseForm = ref({ title: '', amount: '', payer: '' });
                const currentEditId = ref(null);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Token login failed, falling back", e);
                            await signInAnonymously(auth);
                        }
                    } 
                };

                onMounted(() => {
                    initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u) {
                            fetchData();
                        } else {
                            schedule.value = [];
                            expenses.value = [];
                        }
                    });
                });

                const loginWithGoogle = async () => {
                    try {
                        loginError.value = '';
                        if (typeof __initial_auth_token !== 'undefined') {
                             await signInAnonymously(auth);
                        } else {
                            const provider = new GoogleAuthProvider();
                            await signInWithPopup(auth, provider);
                        }
                    } catch (error) {
                        console.error(error);
                        loginError.value = "ç™»å…¥å¤±æ•—: " + error.message;
                    }
                };

                const logout = () => signOut(auth);

                // --- Profile Functions ---
                const openEditProfile = () => {
                    profileForm.value = {
                        displayName: user.value.displayName || '',
                        photoURL: user.value.photoURL || ''
                    };
                    showUserMenu.value = false;
                    showProfileModal.value = true;
                };

                const saveProfile = async () => {
                    if (!user.value) return;
                    try {
                        await updateProfile(user.value, {
                            displayName: profileForm.value.displayName,
                            photoURL: profileForm.value.photoURL
                        });
                        // é›–ç„¶ Firebase ç‹€æ…‹æœƒæ›´æ–°ï¼Œä½†æœ‰æ™‚æœ¬åœ°è®Šæ•¸åæ‡‰æ…¢ï¼Œé€™è£¡å¼·åˆ¶æ›´æ–°æœ¬åœ°é¡¯ç¤º
                        user.value = { ...user.value, ...profileForm.value };
                        showProfileModal.value = false;
                    } catch (e) {
                        alert("æ›´æ–°å¤±æ•—: " + e.message);
                    }
                };

                let unsubSchedule = null;
                let unsubExpenses = null;
                let unsubSettings = null;

                const fetchData = () => {
                    if (!user.value) return;

                    // 1. Settings
                    const settingsRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config');
                    unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                        if (docSnap.exists()) {
                            settings.value = docSnap.data();
                            settingsInput.value = settings.value.users ? settings.value.users.join(', ') : '';
                            destinationInput.value = settings.value.destination || 'æ±äº¬';
                            currencyInput.value = settings.value.currency || 'Â¥';
                        } else {
                            setDoc(settingsRef, settings.value);
                        }
                    });

                    // 2. Schedule
                    const scheduleRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'schedule');
                    unsubSchedule = onSnapshot(scheduleRef, (snapshot) => {
                        schedule.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });

                    // 3. Expenses
                    const expensesRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'expenses');
                    unsubExpenses = onSnapshot(expensesRef, (snapshot) => {
                        expenses.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                };

                const currentDayEvents = computed(() => {
                    return schedule.value.filter(e => e.dayIndex === currentDayIndex.value);
                });

                const sortedEvents = computed(() => {
                    return [...currentDayEvents.value].sort((a, b) => a.time.localeCompare(b.time));
                });

                const sortedExpenses = computed(() => {
                    return [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                });

                const averageExpense = computed(() => {
                    if (!settings.value.users || settings.value.users.length === 0) return 0;
                    return Math.round(totalExpense.value / settings.value.users.length);
                });

                const debts = computed(() => {
                    const usersList = settings.value.users || [];
                    if (usersList.length < 2) return [];
                    
                    const balances = {};
                    usersList.forEach(u => balances[u] = 0);

                    expenses.value.forEach(exp => {
                        const amount = Number(exp.amount);
                        const payer = exp.payer;
                        if (!usersList.includes(payer)) return;

                        const split = amount / usersList.length;
                        balances[payer] += amount;
                        usersList.forEach(u => balances[u] -= split);
                    });

                    let debtors = [];
                    let creditors = [];
                    for (const [u, amount] of Object.entries(balances)) {
                        if (amount < -1) debtors.push({ user: u, amount });
                        if (amount > 1) creditors.push({ user: u, amount });
                    }

                    debtors.sort((a, b) => a.amount - b.amount);
                    creditors.sort((a, b) => b.amount - a.amount);

                    const result = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                        
                        result.push({ from: debtor.user, to: creditor.user, amount: Math.round(amount) });

                        debtor.amount += amount;
                        creditor.amount -= amount;

                        if (Math.abs(debtor.amount) < 1) i++;
                        if (creditor.amount < 1) j++;
                    }
                    return result;
                });

                const addDay = () => {
                    days.value.push(`Day ${days.value.length + 1}`);
                };

                const openAddModal = () => {
                    isEditing.value = false;
                    currentEditId.value = null;
                    form.value = { time: '09:00', title: '', location: '', note: '' };
                    expenseForm.value = { title: '', amount: '', payer: settings.value.users[0] || '' };
                    showModal.value = true;
                };

                const editEvent = (event) => {
                    isEditing.value = true;
                    currentEditId.value = event.id;
                    form.value = { ...event };
                    showModal.value = true;
                };

                const closeModal = () => showModal.value = false;

                const submitForm = async () => {
                    if (!user.value) return;
                    submitting.value = true;
                    
                    try {
                        if (activeTab.value === 'schedule') {
                            if (!form.value.title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                            const coll = collection(db, 'artifacts', appId, 'users', user.value.uid, 'schedule');
                            
                            const data = {
                                ...form.value,
                                dayIndex: currentDayIndex.value,
                                updatedAt: new Date().toISOString()
                            };

                            if (isEditing.value && currentEditId.value) {
                                await updateDoc(doc(coll, currentEditId.value), data);
                            } else {
                                await addDoc(coll, data);
                            }
                        } else {
                            if (!expenseForm.value.title || !expenseForm.value.amount) throw new Error("è³‡æ–™ä¸å®Œæ•´");
                            const coll = collection(db, 'artifacts', appId, 'users', user.value.uid, 'expenses');
                            
                            const data = {
                                ...expenseForm.value,
                                date: new Date().toISOString()
                            };
                            
                            await addDoc(coll, data);
                        }
                        closeModal();
                    } catch (e) {
                        alert(e.message);
                    } finally {
                        submitting.value = false;
                    }
                };

                const deleteItem = async (type, id) => {
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    try {
                        const collStr = type === 'schedule' ? 'schedule' : 'expenses';
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.value.uid, collStr, id));
                    } catch (e) {
                        alert("åˆªé™¤å¤±æ•—");
                    }
                };

                const saveSettings = async () => {
                    const newUsers = settingsInput.value.split(/[,ï¼Œ]/).map(u => u.trim()).filter(u => u);
                    if (newUsers.length === 0) return alert('è‡³å°‘éœ€è¦ä¸€ä½æ—…ä¼´');
                    
                    try {
                        const ref = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config');
                        await setDoc(ref, { 
                            users: newUsers,
                            destination: destinationInput.value || 'æˆ‘çš„æ—…ç¨‹',
                            currency: currencyInput.value || '$'
                        });
                        showSettings.value = false;
                    } catch (e) {
                        alert("å„²å­˜å¤±æ•—: " + e.message);
                    }
                };

                const openMap = (loc) => {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                };
                
                const formatDate = (iso) => {
                    const d = new Date(iso);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                };

                return {
                    user, loading, loginError,
                    activeTab, showModal, showSettings, showUserMenu, showProfileModal, isEditing, submitting,
                    days, currentDayIndex,
                    schedule, expenses, settings, 
                    settingsInput, destinationInput, currencyInput,
                    profileForm,
                    form, expenseForm,
                    currentDayEvents, sortedEvents, sortedExpenses, totalExpense, averageExpense, debts,
                    loginWithGoogle, logout,
                    addDay, openAddModal, editEvent, submitForm, deleteItem, closeModal,
                    saveSettings, openMap, formatDate, openEditProfile, saveProfile
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
