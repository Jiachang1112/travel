<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Pro ğŸŒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#6366f1', secondary: '#ec4899' },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col w-full max-w-md mx-auto bg-gray-50 shadow-2xl relative">

        <Transition name="fade">
            <div v-if="loading" class="absolute inset-0 z-[100] bg-white flex items-center justify-center">
                <div class="flex items-center gap-4 px-6 py-4 bg-white rounded-2xl">
                    <div class="w-10 h-10 rounded-full border-[4px] border-t-indigo-500 border-r-pink-500 border-b-yellow-500 border-l-blue-400 animate-spin"></div>
                    <span class="text-gray-600 font-bold tracking-widest text-lg">æ­£åœ¨è¼‰å…¥</span>
                </div>
            </div>
        </Transition>

        <div v-if="!user && !loading" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
            <div class="w-24 h-24 bg-gradient-to-tr from-primary to-purple-500 rounded-3xl flex items-center justify-center mb-6 shadow-xl transform rotate-3">
                <i class="fas fa-globe-americas text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Travel Pro è‡ªç”±è¡Œ</h1>
            <p class="text-gray-500 mb-10">é›²ç«¯åŒæ­¥ä½ çš„è¡Œç¨‹èˆ‡å¸³å‹™</p>
            
            <button @click="loginWithGoogle" class="flex items-center justify-center w-full bg-white border border-gray-300 rounded-xl py-3.5 px-4 shadow-sm hover:bg-gray-50 transition active:scale-95">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 mr-3" alt="Google">
                <span class="font-medium text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
            <p v-if="loginError" class="text-red-500 text-sm mt-4">{{ loginError }}</p>
        </div>

        <template v-else-if="user && !loading">
            
            <header class="bg-white px-5 py-3 shadow-sm z-10 flex justify-between items-center h-16 shrink-0">
                <div class="flex items-center gap-2">
                    <button v-if="currentView === 'planner'" @click="exitTrip" class="w-8 h-8 flex items-center justify-center -ml-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800 flex items-center">
                            <span v-if="currentView === 'dashboard'">æˆ‘çš„æ—…ç¨‹ ğŸ§³</span>
                            <span v-else>{{ currentTrip.destination || 'æœªå‘½åæ—…ç¨‹' }}</span>
                        </h1>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button v-if="currentView === 'planner'" @click="openTripSettings" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:text-primary hover:bg-indigo-50 flex items-center justify-center transition">
                        <i class="fas fa-cog"></i>
                    </button>

                    <button @click="showUserMenu = true" class="relative group focus:outline-none">
                        <img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" 
                             class="w-9 h-9 rounded-full border border-gray-200 transition transform active:scale-95 object-cover">
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto no-scrollbar p-4 relative bg-gray-50">
                
                <div v-if="currentView === 'dashboard'" class="space-y-4">
                    <div v-if="trips.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-2xl">âœˆï¸</div>
                        <p>é‚„æ²’æœ‰ä»»ä½•æ—…ç¨‹</p>
                        <p class="text-xs mt-2">é»æ“Šå³ä¸‹è§’ã€Œ+ã€é–‹å§‹è¦åŠƒ</p>
                    </div>

                    <div v-for="trip in trips" :key="trip.id" @click="enterTrip(trip)" 
                         class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition active:scale-[0.98] cursor-pointer relative overflow-hidden group">
                        
                        <div v-if="trip.isInvite" class="absolute inset-0 z-20 bg-indigo-600/95 flex flex-col items-center justify-center text-white" @click.stop>
                             <p class="font-bold text-lg mb-1">ğŸ“¬ æ”¶åˆ°æ—…ç¨‹é‚€è«‹</p>
                             <p class="text-xs opacity-80 mb-4">{{ trip.destination }}</p>
                             <div class="flex gap-4">
                                <button @click="respondToInvite(trip, false)" class="px-4 py-2 bg-white/20 rounded-full hover:bg-white/30 text-sm">æ‹’çµ•</button>
                                <button @click="respondToInvite(trip, true)" class="px-4 py-2 bg-white text-indigo-600 font-bold rounded-full hover:bg-gray-100 text-sm">åŠ å…¥</button>
                             </div>
                        </div>

                        <div class="absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-full -mr-8 -mt-8 transition group-hover:bg-primary/10"></div>
                        
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-1">{{ trip.destination }}</h3>
                                <p v-if="trip.startDate" class="text-xs text-gray-400 mb-2 flex items-center">
                                    <i class="far fa-calendar-alt mr-1.5"></i> 
                                    {{ trip.startDate.replace(/-/g, '/') }} 
                                    <span v-if="trip.endDate" class="mx-1">~</span> 
                                    {{ trip.endDate ? trip.endDate.replace(/-/g, '/') : '' }}
                                </p>
                                <p class="text-xs text-gray-500 flex items-center gap-1">
                                    <span class="bg-gray-100 px-1.5 py-0.5 rounded font-mono">{{ trip.currency }}</span>
                                    <span v-if="trip.companions && trip.companions.length > 0">Â· {{ trip.companions.length }} äººåŒè¡Œ</span>
                                </p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 mt-2"></i>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'planner'">
                    
                    <div v-if="activeTab === 'schedule'">
                        <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6 p-2">
                            <button v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                                :class="currentDayIndex === index ? 'bg-primary text-white shadow-lg shadow-indigo-200 ring-2 ring-primary ring-offset-1' : 'bg-white text-gray-500 border border-gray-100'"
                                class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium transition-all whitespace-nowrap">
                                Day {{ index + 1 }}
                            </button>
                        </div>

                        <div v-if="currentDayEvents.length > 0" class="space-y-4 pl-2 pb-20">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-6 border-l-2 border-gray-200 last:border-transparent pb-4 group">
                                <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm z-10"></div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-primary font-bold text-lg font-mono tracking-tight">{{ event.time }}</span>
                                        <div class="flex space-x-3 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="editEvent(event)" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                            <button @click="deleteItem('schedule', event.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-gray-800 text-lg mb-1">{{ event.title }}</h3>
                                    <div v-if="event.location" class="flex items-center text-gray-500 text-sm mb-2 cursor-pointer" @click="openMap(event.location)">
                                        <i class="fas fa-map-marker-alt mr-1.5 text-secondary"></i>
                                        <span class="truncate border-b border-dashed border-gray-300 hover:text-gray-700">{{ event.location }}</span>
                                    </div>
                                    <p v-if="event.note" class="text-gray-400 text-sm mt-2 pt-2 border-t border-gray-50 flex items-start">
                                        <i class="fas fa-info-circle mr-1.5 mt-0.5 opacity-50"></i> <span>{{ event.note }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ—“ï¸</div>
                            <p>Day {{ currentDayIndex + 1 }} é‚„æ˜¯ç©ºçš„</p>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'expense'" class="pb-20">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-xl shadow-gray-200/50 mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                            <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">ç¸½æ”¯å‡º</p>
                            <h2 class="text-4xl font-bold font-mono tracking-tight flex items-baseline">
                                <span class="text-xl mr-1">{{ currentTrip.currency || '$' }}</span>{{ totalExpense.toLocaleString() }}
                            </h2>
                            <div class="mt-6 flex justify-between items-end">
                                <div>
                                    <p class="text-gray-400 text-xs mb-1">å¹³å‡æ¯äºº</p>
                                    <p class="font-mono text-lg">{{ currentTrip.currency || '$' }} {{ averageExpense.toLocaleString() }}</p>
                                </div>
                                <div class="flex -space-x-2">
                                    <div v-for="(u, i) in (currentTrip.companions || [])" :key="i" class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-800 flex items-center justify-center text-xs font-bold text-gray-300">
                                        {{ u.charAt(0) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="flex justify-between items-end mb-2">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">é ç®—ç‹€æ…‹</h3>
                                <button @click="openTripSettings" class="text-xs text-primary font-bold hover:underline">
                                    {{ currentTrip.budget > 0 ? 'èª¿æ•´' : 'è¨­å®šé ç®—' }}
                                </button>
                            </div>
                            <div v-if="currentTrip.budget > 0">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>å·²ç”¨ {{ Math.round(budgetPercentage) }}%</span>
                                    <span :class="remainingBudget < 0 ? 'text-red-500 font-bold' : ''">å‰©é¤˜ {{ currentTrip.currency }}{{ remainingBudget.toLocaleString() }}</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                    <div class="h-2.5 rounded-full transition-all duration-500" :class="budgetColor" :style="{ width: Math.min(budgetPercentage, 100) + '%' }"></div>
                                </div>
                                <p class="text-xs text-gray-300 mt-2 text-right">ç¸½é ç®— {{ currentTrip.currency }}{{ Number(currentTrip.budget).toLocaleString() }}</p>
                            </div>
                            <div v-else class="text-center py-2">
                                <p class="text-xs text-gray-400 mb-2">å°šæœªè¨­å®šæ—…éŠé ç®—</p>
                                <button @click="openTripSettings" class="w-full py-2 bg-gray-50 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-100 border border-dashed border-gray-300">
                                    <i class="fas fa-plus-circle mr-1"></i> æ–°å¢é ç®—ä¸Šé™
                                </button>
                            </div>
                        </div>

                        <div v-if="debts.length > 0" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 text-sm mb-3 uppercase tracking-wide">çµç®—æ–¹æ¡ˆ</h3>
                            <div class="space-y-3">
                                <div v-for="(debt, idx) in debts" :key="idx" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex items-center text-sm">
                                        <span class="font-bold text-gray-700">{{ debt.from }}</span>
                                        <i class="fas fa-long-arrow-alt-right mx-2 text-gray-400"></i>
                                        <span class="font-bold text-gray-700">{{ debt.to }}</span>
                                    </div>
                                    <span class="font-mono font-bold text-secondary">{{ currentTrip.currency || '$' }}{{ debt.amount.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>

                        <div v-if="sortedExpenses.length > 0" class="space-y-3">
                            <div v-for="expense in sortedExpenses" :key="expense.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary font-bold text-sm shrink-0">
                                        {{ expense.payer ? expense.payer.charAt(0) : '?' }}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 leading-tight">{{ expense.title }}</p>
                                        <p class="text-xs text-gray-400 mt-0.5">{{ formatDate(expense.date) }} Â· {{ expense.payer }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold font-mono text-gray-800">{{ currentTrip.currency || '$' }}{{ parseInt(expense.amount).toLocaleString() }}</p>
                                    <button @click="deleteItem('expenses', expense.id)" class="text-gray-300 text-xs mt-1 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ’¸</div>
                            <p>è«‹é»é¸å³ä¸‹è§’+ æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç­†æ”¯å‡ºå§ï¼</p>
                        </div>
                    </div>
                </div>

            </main>

            <button @click="onFabClick" class="absolute bottom-24 right-5 w-14 h-14 bg-gray-900 text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-xl hover:scale-105 active:scale-95 transition z-40"><i class="fas fa-plus"></i></button>

            <nav v-if="currentView === 'planner'" class="bg-white border-t border-gray-100 pb-safe pt-2 px-6 flex justify-between items-center z-30 pb-4 h-20 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
                <button @click="activeTab = 'schedule'" class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200" :class="activeTab === 'schedule' ? 'text-primary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-map-marked-alt text-xl mb-0.5 transform transition" :class="activeTab === 'schedule' ? 'scale-110' : ''"></i><span class="text-[10px] font-bold tracking-wide">è¡Œç¨‹</span>
                </button>
                <div class="w-px h-8 bg-gray-100"></div>
                <button @click="activeTab = 'expense'" class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200" :class="activeTab === 'expense' ? 'text-secondary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-wallet text-xl mb-0.5 transform transition" :class="activeTab === 'expense' ? 'scale-110' : ''"></i><span class="text-[10px] font-bold tracking-wide">åˆ†å¸³</span>
                </button>
            </nav>

            <Transition name="slide-up">
                <div v-if="showItemModal" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-[2px]" @click.self="showItemModal = false">
                    <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[85vh] sm:h-auto flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">{{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }} {{ activeTab === 'schedule' ? 'è¡Œç¨‹' : 'æ”¯å‡º' }}</h3>
                            <button @click="showItemModal = false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar space-y-5">
                            <div v-if="activeTab === 'schedule'" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ™‚é–“</label><input v-model="form.time" type="time" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary text-lg font-mono"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ´»å‹•</label><input v-model="form.title" type="text" placeholder="ä¾‹å¦‚ï¼šé€›å¤œå¸‚" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">åœ°é»</label><div class="relative"><i class="fas fa-map-pin absolute left-4 top-4 text-gray-400"></i><input v-model="form.location" type="text" placeholder="è¼¸å…¥ Google Maps é—œéµå­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-10 outline-none focus:border-primary"></div></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å‚™è¨»</label><textarea v-model="form.note" rows="3" placeholder="ç¥¨åˆ¸è³‡è¨Š..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary resize-none"></textarea></div>
                            </div>
                            <div v-if="activeTab === 'expense'" class="space-y-5">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é‡‘é¡</label><div class="relative"><span class="absolute left-4 top-3.5 text-gray-400 font-bold">{{ currentTrip.currency }}</span><input v-model.number="expenseForm.amount" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-14 outline-none focus:border-secondary text-2xl font-mono font-bold"></div></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é …ç›®</label><input v-model="expenseForm.title" type="text" placeholder="ä¾‹å¦‚ï¼šæ™šé¤" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-secondary"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä»˜æ¬¾äºº</label><div class="grid grid-cols-3 gap-2"><button v-for="u in (currentTrip.companions || [])" :key="u" @click="expenseForm.payer = u" :class="expenseForm.payer === u ? 'bg-secondary text-white shadow-md shadow-pink-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="py-2.5 rounded-lg text-sm font-medium transition">{{ u }}</button></div></div>
                            </div>
                        </div>
                        <button @click="submitItem" class="w-full mt-4 py-4 rounded-2xl text-white font-bold text-lg shadow-lg active:scale-[0.98] transition flex items-center justify-center" :class="activeTab === 'schedule' ? 'bg-primary shadow-indigo-200 hover:bg-indigo-600' : 'bg-secondary shadow-pink-200 hover:bg-pink-600'">
                            <span v-if="submitting" class="loader border-white border-t-transparent w-5 h-5 mr-2"></span>{{ isEditing ? 'å„²å­˜è®Šæ›´' : 'ç¢ºèªæ–°å¢' }}
                        </button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showTripModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showTripModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5 max-h-[90vh] overflow-y-auto">
                        
                        <div v-if="!showCompanionManager">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800">{{ currentTrip.id ? 'æ—…ç¨‹è¨­å®š' : 'å»ºç«‹æ–°æ—…ç¨‹' }}</h3>
                                <button @click="showTripModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="space-y-5 mb-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">ç›®çš„åœ°</label>
                                    <div class="relative">
                                        <input readonly @click="showDestinationModal = true" v-model="tripForm.destination" type="text" placeholder="é»æ“Šé¸æ“‡" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary cursor-pointer pr-10">
                                        <i class="fas fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ—…éŠæ—¥æœŸ</label>
                                    <div class="flex items-center gap-2">
                                        <input v-model="tripForm.startDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary text-sm">
                                        <span class="text-gray-400 font-bold">-</span>
                                        <input v-model="tripForm.endDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary text-sm">
                                    </div>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">è²¨å¹£ç¬¦è™Ÿ</label><input v-model="tripForm.currency" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é ç®—ä¸Šé™</label><input v-model.number="tripForm.budget" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary"></div>
                                
                                <div @click="showCompanionManager = true" class="cursor-pointer group">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                                    <div class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 flex justify-between items-center group-hover:border-primary transition">
                                        <span class="text-gray-800 truncate">{{ (tripForm.companions || []).join(', ') || 'ç„¡' }}</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button v-if="currentTrip.id" @click="deleteTrip" class="flex-1 py-3.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 font-bold text-sm flex items-center justify-center">
                                    <i class="fas fa-trash-alt mr-2"></i>åˆªé™¤æ—…ç¨‹
                                </button>
                                <button @click="saveTrip" class="flex-[2] py-3.5 bg-gray-900 text-white rounded-xl hover:bg-gray-800 font-bold shadow-lg text-lg">{{ currentTrip.id ? 'å„²å­˜è®Šæ›´' : 'å»ºç«‹æ—…ç¨‹' }}</button>
                            </div>
                        </div>

                        <div v-else>
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800">ç®¡ç†æ—…ä¼´</h3>
                                <button @click="showCompanionManager = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                            </div>
                            
                            <div class="space-y-6 mb-8">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ–°å¢å¤¥ä¼´ (è¼¸å…¥ EMAIL)</label>
                                    <div class="flex gap-2">
                                        <input v-model="inviteEmail" type="email" placeholder="example@gmail.com" class="flex-1 bg-white border border-gray-200 rounded-lg p-3 text-sm outline-none focus:border-primary shadow-sm">
                                        <button @click="sendInvite" class="bg-primary text-white px-5 rounded-lg text-sm font-bold hover:bg-indigo-600 shadow-md shadow-indigo-200 whitespace-nowrap">é‚€è«‹</button>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">ç¢ºèªåå–® / é‚€è«‹ä¸­</label>
                                    <div class="space-y-3">
                                        <div v-for="email in tripForm.pendingEmails" :key="email" class="bg-yellow-50 border border-yellow-100 rounded-2xl p-3.5 flex justify-between items-center">
                                            <div class="flex items-center gap-3.5">
                                                <div class="w-9 h-9 rounded-full bg-yellow-200 text-yellow-600 flex items-center justify-center text-sm shadow-sm"><i class="fas fa-envelope"></i></div>
                                                <div class="overflow-hidden">
                                                    <p class="font-bold text-gray-800 text-sm truncate w-32 sm:w-40">{{ email }}</p>
                                                    <p class="text-[10px] text-yellow-600 font-bold mt-0.5">ç­‰å¾…å›æ‡‰ä¸­...</p>
                                                </div>
                                            </div>
                                            <button v-if="isOwner" @click="removePending(email)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition"><i class="fas fa-times"></i></button>
                                        </div>
                                        
                                        <div v-for="(comp, index) in tripForm.companions" :key="index" class="bg-gray-50 border border-gray-100 rounded-2xl p-3.5 flex justify-between items-center">
                                            <div class="flex items-center gap-3.5">
                                                <div class="w-9 h-9 rounded-full bg-teal-500 text-white flex items-center justify-center font-bold text-sm shadow-sm overflow-hidden">
                                                     <span v-if="!getMemberPhoto(comp)">{{ comp.charAt(0) }}</span>
                                                     <img v-else :src="getMemberPhoto(comp)" class="w-full h-full object-cover">
                                                </div>
                                                <p class="font-bold text-gray-800 text-sm">{{ comp }}</p>
                                            </div>
                                            
                                            <div v-if="index === 0" class="bg-gray-200 text-gray-500 text-[10px] px-2 py-1 rounded font-bold tracking-wider">ä¸»è¾¦äºº</div>
                                            <button v-else-if="isOwner" @click="removeCompanion(index)" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button @click="showCompanionManager = false" class="w-full py-3.5 bg-gray-800 text-white rounded-xl hover:bg-gray-900 font-bold shadow-lg text-lg">å®Œæˆè¨­å®š</button>
                        </div>

                    </div>
                </div>
            </Transition>

            <Transition name="fade"><div v-if="showDestinationModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showDestinationModal = false"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl mx-5 overflow-hidden flex flex-col max-h-[70vh]"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"><h3 class="font-bold text-gray-800">é¸æ“‡ç›®çš„åœ°</h3><button @click="showDestinationModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="flex border-b border-gray-200"><button v-for="key in Object.keys(regions)" :key="key" @click="activeRegion = key" :class="activeRegion === key ? 'border-primary text-primary bg-indigo-50' : 'border-transparent text-gray-500 hover:bg-gray-50'" class="flex-1 py-3 text-sm font-bold border-b-2 transition">{{ key }}</button></div><div class="p-4 overflow-y-auto grid grid-cols-2 gap-3 bg-gray-50/50 flex-1"><button v-for="country in regions[activeRegion]" :key="country.name" @click="selectDestination(country)" class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-primary hover:shadow-md transition text-left flex items-center justify-between group"><span class="font-medium text-gray-700 group-hover:text-primary">{{ country.name }}</span><span class="text-xs font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{{ country.currency }}</span></button></div></div></div></Transition>
            <Transition name="fade"><div v-if="showUserMenu" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showUserMenu = false"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5"><div class="flex justify-end mb-2"><button @click="showUserMenu = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="flex flex-col items-center mb-6"><img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" class="w-20 h-20 rounded-full border-4 border-gray-50 shadow-md mb-3 object-cover"><h3 class="text-xl font-bold text-gray-800">{{ settings.displayName || user.displayName || 'ä½¿ç”¨è€…' }}</h3><p class="text-sm text-gray-400 font-mono">{{ user.email }}</p><div @click="copyUid" class="mt-2 flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full cursor-pointer hover:bg-gray-200 transition group" title="é»æ“Šè¤‡è£½ UID"><span class="text-[10px] font-mono text-gray-500 break-all max-w-[200px] truncate">UID: {{ user.uid }}</span><i class="fas fa-copy text-xs text-gray-400 group-hover:text-primary"></i></div><p v-if="copyToast" class="text-xs text-green-500 font-bold mt-1 transition-all">{{ copyToast }}</p></div><div class="flex flex-col gap-3"><button @click="openEditProfile" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-bold flex items-center justify-center gap-2"><i class="fas fa-edit"></i> ç·¨è¼¯æª”æ¡ˆ</button><button @click="confirmAction('logout')" class="w-full py-3 text-red-500 bg-red-50 border border-red-100 rounded-xl hover:bg-red-100 font-bold flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºå¸³è™Ÿ</button></div></div></div></Transition>
            <Transition name="fade"><div v-if="showConfirmModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showConfirmModal = false"><div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5 text-center"><div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fas fa-exclamation-triangle"></i></div><h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºèªæ“ä½œ</h3><p class="text-sm text-gray-500 mb-6">{{ confirmMessage }}</p><div class="flex gap-3"><button @click="showConfirmModal = false" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200">å–æ¶ˆ</button><button @click="executeConfirm" class="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-200">ç¢ºå®š</button></div></div></div></Transition>
            <Transition name="fade"><div v-if="showErrorModal" class="absolute inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showErrorModal = false"><div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5 text-center"><div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fas fa-exclamation"></i></div><h3 class="text-lg font-bold text-gray-800 mb-2">æç¤º</h3><p class="text-sm text-gray-500 mb-6">{{ errorMessage }}</p><button @click="showErrorModal = false" class="w-full py-2.5 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900 shadow-lg">ç¢ºå®š</button></div></div></Transition>
            <Transition name="fade"><div v-if="showProfileModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showProfileModal = false"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5"><div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3><button @click="showProfileModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="space-y-4 mb-6"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å§“å / æš±ç¨±</label><input v-model="profileForm.displayName" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é ­è²¼é€£çµ (URL)</label><input v-model="profileForm.photoURL" type="text" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div></div><button @click="saveProfile" class="w-full py-2.5 bg-primary text-white rounded-xl hover:bg-indigo-600 font-bold shadow-lg shadow-indigo-200">å„²å­˜è®Šæ›´</button></div></div></Transition>

        </template>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch, where, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = { apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, authDomain: "travel-fa395.firebaseapp.com", projectId: "travel-fa395", storageBucket: "travel-fa395.firebasestorage.app", messagingSenderId: "837385103808", appId: "1:837385103808:web:f998a17e4aeccf4b7f8025", measurementId: "G-31D354GWVR" };
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { createApp, ref, computed, watch, onMounted } = window.Vue;

        const regions = { 'æ±': [{ name: 'æ—¥æœ¬', currency: 'Â¥' }, { name: 'éŸ“åœ‹', currency: 'â‚©' }, { name: 'å°ç£', currency: 'NT$' }, { name: 'é¦™æ¸¯', currency: 'HK$' }, { name: 'ä¸­åœ‹', currency: 'Â¥' }], 'å—': [{ name: 'æ³°åœ‹', currency: 'à¸¿' }, { name: 'è¶Šå—', currency: 'â‚«' }, { name: 'æ–°åŠ å¡', currency: 'S$' }, { name: 'é¦¬ä¾†è¥¿äº', currency: 'RM' }, { name: 'è²å¾‹è³“', currency: 'â‚±' }, { name: 'æ¾³æ´²', currency: 'A$' }], 'è¥¿': [{ name: 'ç¾åœ‹', currency: '$' }, { name: 'è‹±åœ‹', currency: 'Â£' }, { name: 'æ­ç›Ÿ', currency: 'â‚¬' }, { name: 'åŠ æ‹¿å¤§', currency: 'C$' }], 'åŒ—': [{ name: 'åŒ—æµ·é“', currency: 'Â¥' }, { name: 'ä¿„ç¾…æ–¯', currency: 'â‚½' }] };

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const loginError = ref('');
                const currentView = ref('dashboard');
                const trips = ref([]);
                const currentTrip = ref({});
                const activeTab = ref('schedule');
                const days = ref([]);
                const currentDayIndex = ref(0);
                const showItemModal = ref(false);
                const showTripModal = ref(false);
                const showUserMenu = ref(false); 
                const showProfileModal = ref(false);
                const showDestinationModal = ref(false);
                const showConfirmModal = ref(false);
                const showErrorModal = ref(false);
                const confirmMessage = ref('');
                const pendingAction = ref(null);
                const errorMessage = ref('');
                const copyToast = ref('');
                const inviteEmail = ref('');
                const activeRegion = ref('æ±');
                const isEditing = ref(false);
                const submitting = ref(false);
                const currentEditId = ref(null);
                const schedule = ref([]);
                const expenses = ref([]);
                const settings = ref({});
                const profileForm = ref({ displayName: '', photoURL: '' });
                const tripForm = ref({ destination: '', currency: '', companions: [], members: [], pendingEmails: [], startDate: '', endDate: '', budget: 0 });
                const form = ref({ time: '10:00', title: '', location: '', note: '' });
                const expenseForm = ref({ title: '', amount: '', payer: '' });
                const showCompanionManager = ref(false);

                let unsubTrips = null;
                let unsubInvites = null;
                let unsubTripMetadata = null; 
                let unsubSchedule = null;
                let unsubExpenses = null;
                let unsubSettings = null;

                // Computed Owner Check
                const isOwner = computed(() => {
                    if (!currentTrip.value.memberUids || currentTrip.value.memberUids.length === 0) return true; // Default create mode
                    return currentTrip.value.memberUids[0] === user.value.uid; // First member is owner
                });

                const initAuth = async () => { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); } } };

                onMounted(() => {
                    initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u) { fetchGlobalData(); } else { trips.value = []; schedule.value = []; expenses.value = []; }
                    });
                });

                const showAlert = (msg) => { errorMessage.value = msg; showErrorModal.value = true; };
                const confirmAction = (actionType, payload) => {
                    if (actionType === 'logout') { confirmMessage.value = 'æ‚¨ç¢ºå®šè¦ç™»å‡ºç›®å‰çš„å¸³è™Ÿå—ï¼Ÿ'; pendingAction.value = async () => { await signOut(auth); showUserMenu.value = false; }; } 
                    else if (actionType === 'reduce_days') { confirmMessage.value = 'ç¸®çŸ­è¡Œç¨‹å°‡æœƒåˆªé™¤è¶…å‡ºå¤©æ•¸çš„è¡Œç¨‹è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ'; pendingAction.value = payload; }
                    showConfirmModal.value = true;
                };
                const executeConfirm = async () => { if (pendingAction.value) { await pendingAction.value(); pendingAction.value = null; } showConfirmModal.value = false; };
                const loginWithGoogle = async () => { try { loginError.value = ''; if (typeof __initial_auth_token !== 'undefined') { await signInAnonymously(auth); } else { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); } } catch (error) { showAlert("ç™»å…¥å¤±æ•—: " + error.message); } };
                const copyUid = async () => { if (user.value && user.value.uid) { try { await navigator.clipboard.writeText(user.value.uid); copyToast.value = 'å·²è¤‡è£½!'; setTimeout(() => copyToast.value = '', 2000); } catch (err) { console.error('Failed to copy!', err); } } };

                const fetchGlobalData = () => {
                    const settingsRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config');
                    unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                        if (docSnap.exists()) {
                            settings.value = docSnap.data();
                            if (!user.value.displayName && settings.value.displayName) user.value.displayName = settings.value.displayName;
                            if (!user.value.photoURL && settings.value.photoURL) user.value.photoURL = settings.value.photoURL;
                        }
                    });

                    const tripsRef = collection(db, 'artifacts', appId, 'trips');
                    const q = query(tripsRef, where('memberUids', 'array-contains', user.value.uid));
                    unsubTrips = onSnapshot(q, (snapshot) => {
                        const myTrips = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        mergeTrips(myTrips, 'owned');
                    });
                    
                    if(user.value.email) {
                        const qInvite = query(tripsRef, where('pendingEmails', 'array-contains', user.value.email));
                        unsubInvites = onSnapshot(qInvite, (snapshot) => {
                            const invitedTrips = snapshot.docs.map(d => ({ id: d.id, ...d.data(), isInvite: true }));
                            mergeTrips(invitedTrips, 'invited');
                        });
                    }
                };

                let tripsCache = { owned: [], invited: [] };
                const mergeTrips = (data, type) => {
                    tripsCache[type] = data;
                    trips.value = [...tripsCache.owned, ...tripsCache.invited].sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                };

                const onFabClick = () => {
                    if (currentView.value === 'dashboard') {
                        tripForm.value = { destination: '', currency: 'Â¥', companions: [user.value.displayName || 'æˆ‘'], members: [], pendingEmails: [], startDate: '', endDate: '', budget: 0 };
                        currentTrip.value = {}; 
                        showTripModal.value = true;
                        showCompanionManager.value = false;
                    } else { openAddItemModal(); }
                };

                const calculateDays = (start, end) => {
                    if (!start || !end) return [];
                    const s = new Date(start); const e = new Date(end);
                    return Array.from({length: Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) + 1}, (_, i) => `Day ${i + 1}`);
                };

                const saveTrip = async () => {
                    if (!tripForm.value.destination) return showAlert('è«‹è¼¸å…¥ç›®çš„åœ°');
                    if (!tripForm.value.startDate || !tripForm.value.endDate) return showAlert('è«‹é¸æ“‡æ—…éŠæ—¥æœŸ');
                    const newDays = calculateDays(tripForm.value.startDate, tripForm.value.endDate);
                    
                    const tripData = {
                        destination: tripForm.value.destination,
                        currency: tripForm.value.currency,
                        companions: tripForm.value.companions || ['æˆ‘'],
                        pendingEmails: tripForm.value.pendingEmails || [],
                        startDate: tripForm.value.startDate,
                        endDate: tripForm.value.endDate,
                        budget: tripForm.value.budget || 0,
                        updatedAt: new Date().toISOString()
                    };
                    
                    if(!currentTrip.value.id) {
                         tripData.memberUids = [user.value.uid];
                         tripData.members = [{uid: user.value.uid, name: user.value.displayName || 'æˆ‘', photo: user.value.photoURL}];
                    } else {
                         let existingMembers = currentTrip.value.memberUids || [];
                         if(!existingMembers.includes(user.value.uid)) existingMembers.push(user.value.uid);
                         tripData.memberUids = existingMembers;
                    }

                    const performSave = async () => {
                        try {
                            const tripsRef = collection(db, 'artifacts', appId, 'trips');
                            if (currentTrip.value.id) {
                                if (newDays.length < days.value.length) {
                                    const eventsToDelete = schedule.value.filter(e => e.dayIndex >= newDays.length);
                                    if (eventsToDelete.length > 0) {
                                        const batch = writeBatch(db);
                                        const tripDocRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                                        eventsToDelete.forEach(ev => batch.delete(doc(tripDocRef, 'schedule', ev.id)));
                                        await batch.commit();
                                    }
                                }
                                await updateDoc(doc(tripsRef, currentTrip.value.id), tripData);
                                days.value = newDays;
                            } else { await addDoc(tripsRef, tripData); }
                            showTripModal.value = false;
                        } catch (e) { showAlert("å„²å­˜å¤±æ•—: " + e.message); }
                    };

                    if (currentTrip.value.id && newDays.length < days.value.length && schedule.value.some(e => e.dayIndex >= newDays.length)) {
                        confirmAction('reduce_days', performSave);
                    } else { performSave(); }
                };

                // NEW: Delete Trip Function
                const deleteTrip = async () => {
                    const doDelete = async () => {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'trips', currentTrip.value.id));
                            showTripModal.value = false;
                            showConfirmModal.value = false;
                            // Optimistic update
                            trips.value = trips.value.filter(t => t.id !== currentTrip.value.id);
                        } catch (e) {
                            showAlert("åˆªé™¤å¤±æ•—: " + e.message);
                        }
                    };
                    confirmMessage.value = "ç¢ºå®šè¦åˆªé™¤æ•´å€‹æ—…ç¨‹å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡ç„¡æ³•å¾©åŸã€‚";
                    pendingAction.value = doDelete;
                    showConfirmModal.value = true;
                };

                const enterTrip = (trip) => {
                    if (trip.isInvite) return;
                    currentTrip.value = trip;
                    currentView.value = 'planner';
                    activeTab.value = 'schedule';
                    days.value = calculateDays(trip.startDate, trip.endDate);
                    if (days.value.length === 0) days.value = ['Day 1'];

                    const tripDocRef = doc(db, 'artifacts', appId, 'trips', trip.id);
                    
                    // FIXED: Listen to the trip itself for LIVE member updates
                    unsubTripMetadata = onSnapshot(tripDocRef, (docSnap) => {
                        if (!docSnap.exists()) {
                            showAlert("æ­¤æ—…ç¨‹å·²è¢«åˆªé™¤");
                            exitTrip();
                            return;
                        }
                        const data = docSnap.data();
                        // æª¢æŸ¥è‡ªå·±æ˜¯å¦é‚„åœ¨æˆå“¡åå–®ä¸­
                        if (!data.memberUids || !data.memberUids.includes(user.value.uid)) {
                            showAlert("æ‚¨å·²è¢«ç§»å‡ºæ­¤æ—…ç¨‹"); // Show message
                            exitTrip(); // Go back to dashboard immediately
                            return;
                        }
                        currentTrip.value = { id: trip.id, ...data };
                    });

                    unsubSchedule = onSnapshot(collection(tripDocRef, 'schedule'), (s) => schedule.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    unsubExpenses = onSnapshot(collection(tripDocRef, 'expenses'), (s) => expenses.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                const exitTrip = () => {
                    currentView.value = 'dashboard';
                    currentTrip.value = {};
                    schedule.value = []; expenses.value = [];
                    if (unsubSchedule) unsubSchedule();
                    if (unsubExpenses) unsubExpenses();
                    if (unsubTripMetadata) unsubTripMetadata();
                };

                const openTripSettings = () => {
                    tripForm.value = {
                        destination: currentTrip.value.destination,
                        currency: currentTrip.value.currency,
                        companions: currentTrip.value.companions || [],
                        members: currentTrip.value.members || [], 
                        pendingEmails: currentTrip.value.pendingEmails || [],
                        startDate: currentTrip.value.startDate || '',
                        endDate: currentTrip.value.endDate || '',
                        budget: currentTrip.value.budget || 0
                    };
                    showTripModal.value = true;
                    showCompanionManager.value = false;
                };

                const getMemberPhoto = (name) => {
                    const mem = (tripForm.value.members || []).find(m => m.name === name);
                    return mem ? mem.photo : null;
                };

                const openEditProfile = () => { profileForm.value = { displayName: settings.value.displayName || user.value.displayName || '', photoURL: settings.value.photoURL || user.value.photoURL || '' }; showUserMenu.value = false; showProfileModal.value = true; };
                const saveProfile = async () => { if (!user.value) return; try { await updateProfile(user.value, { displayName: profileForm.value.displayName, photoURL: profileForm.value.photoURL }); const ref = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config'); await setDoc(ref, { displayName: profileForm.value.displayName, photoURL: profileForm.value.photoURL }, { merge: true }); showProfileModal.value = false; } catch (e) { showAlert("æ›´æ–°å¤±æ•—: " + e.message); } };
                const openAddItemModal = () => { isEditing.value = false; currentEditId.value = null; form.value = { time: '09:00', title: '', location: '', note: '' }; expenseForm.value = { title: '', amount: '', payer: currentTrip.value.companions[0] || '' }; showItemModal.value = true; };
                const editEvent = (event) => { isEditing.value = true; currentEditId.value = event.id; form.value = { ...event }; showItemModal.value = true; };

                const submitItem = async () => {
                    submitting.value = true;
                    const tripDocRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                    try {
                        if (activeTab.value === 'schedule') {
                            if (!form.value.title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                            const coll = collection(tripDocRef, 'schedule');
                            const data = { ...form.value, dayIndex: currentDayIndex.value, updatedAt: new Date().toISOString() };
                            if (isEditing.value && currentEditId.value) await updateDoc(doc(coll, currentEditId.value), data); else await addDoc(coll, data);
                        } else {
                            if (!expenseForm.value.title || !expenseForm.value.amount) throw new Error("è³‡æ–™ä¸å®Œæ•´");
                            await addDoc(collection(tripDocRef, 'expenses'), { ...expenseForm.value, date: new Date().toISOString() });
                        }
                        showItemModal.value = false;
                    } catch (e) { showAlert(e.message); } finally { submitting.value = false; }
                };

                const deleteItem = async (type, id) => {
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    const tripDocRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                    try { await deleteDoc(doc(tripDocRef, type === 'schedule' ? 'schedule' : 'expenses', id)); } catch (e) { showAlert("åˆªé™¤å¤±æ•—"); }
                };

                const selectDestination = (c) => { tripForm.value.destination = c.name; tripForm.value.currency = c.currency; showDestinationModal.value = false; };
                const addDay = async () => { if (!currentTrip.value.endDate) return showAlert("è«‹å…ˆè¨­å®šæ—…éŠæ—¥æœŸ"); const date = new Date(currentTrip.value.endDate); date.setDate(date.getDate() + 1); const newEndDate = date.toISOString().split('T')[0]; const tripsRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id); await updateDoc(tripsRef, { endDate: newEndDate }); currentTrip.value.endDate = newEndDate; days.value = calculateDays(currentTrip.value.startDate, newEndDate); };
                const openMap = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                const formatDate = (iso) => { const d = new Date(iso); return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };

                const sendInvite = async () => {
                    if (!inviteEmail.value || !inviteEmail.value.includes('@')) return showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email");
                    if (tripForm.value.pendingEmails.includes(inviteEmail.value)) return showAlert("å·²é‚€è«‹éæ­¤äºº");
                    
                    if (!currentTrip.value.id) {
                        tripForm.value.pendingEmails.push(inviteEmail.value);
                    } else {
                        try {
                            const tripRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                            await updateDoc(tripRef, { pendingEmails: arrayUnion(inviteEmail.value) });
                            tripForm.value.pendingEmails.push(inviteEmail.value);
                        } catch (e) { console.error(e); showAlert("é‚€è«‹ç™¼é€å¤±æ•—"); }
                    }
                    inviteEmail.value = '';
                };

                const respondToInvite = async (trip, accept) => {
                    const tripRef = doc(db, 'artifacts', appId, 'trips', trip.id);
                    const batch = writeBatch(db);
                    if (accept) {
                        const myData = {uid: user.value.uid, name: settings.value.displayName || user.value.displayName || 'æ–°æˆå“¡', photo: settings.value.photoURL || user.value.photoURL};
                        batch.update(tripRef, { 
                            memberUids: arrayUnion(user.value.uid),
                            pendingEmails: arrayRemove(user.value.email),
                            companions: arrayUnion(myData.name),
                            members: arrayUnion(myData)
                        });
                    } else { batch.update(tripRef, { pendingEmails: arrayRemove(user.value.email) }); }
                    await batch.commit();
                };

                // Updated remove logic with custom confirm modal
                const removePending = async (email) => {
                    const doRemove = async () => {
                        if(!currentTrip.value.id) {
                            tripForm.value.pendingEmails = tripForm.value.pendingEmails.filter(e => e !== email);
                        } else {
                            const tripRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                            await updateDoc(tripRef, { pendingEmails: arrayRemove(email) });
                            tripForm.value.pendingEmails = tripForm.value.pendingEmails.filter(e => e !== email);
                        }
                        showConfirmModal.value = false;
                    };
                    confirmMessage.value = `ç¢ºå®šå–æ¶ˆé‚€è«‹ ${email} å—ï¼Ÿ`;
                    pendingAction.value = doRemove;
                    showConfirmModal.value = true;
                };

                const removeCompanion = async (index) => {
                    const nameToRemove = tripForm.value.companions[index];
                    const doRemove = async () => {
                        if(!currentTrip.value.id) {
                            tripForm.value.companions.splice(index, 1);
                        } else {
                             const memberObj = (tripForm.value.members || []).find(m => m.name === nameToRemove);
                             const uidToRemove = memberObj ? memberObj.uid : null;
                             const batch = writeBatch(db);
                             const tripRef = doc(db, 'artifacts', appId, 'trips', currentTrip.value.id);
                             
                             batch.update(tripRef, { companions: arrayRemove(nameToRemove) });
                             if (uidToRemove) {
                                 batch.update(tripRef, { memberUids: arrayRemove(uidToRemove), members: arrayRemove(memberObj) });
                             }
                             await batch.commit();
                             tripForm.value.companions.splice(index, 1);
                        }
                        showConfirmModal.value = false;
                    };
                    confirmMessage.value = `ç¢ºå®šç§»é™¤æˆå“¡ ${nameToRemove}ï¼Ÿè©²æˆå“¡å°‡ç„¡æ³•å­˜å–æ—…ç¨‹ã€‚`;
                    pendingAction.value = doRemove;
                    showConfirmModal.value = true;
                };

                const currentDayEvents = computed(() => schedule.value.filter(e => e.dayIndex === currentDayIndex.value));
                const sortedEvents = computed(() => [...currentDayEvents.value].sort((a, b) => a.time.localeCompare(b.time)));
                const sortedExpenses = computed(() => [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date)));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const averageExpense = computed(() => {
                    if (!currentTrip.value.companions || currentTrip.value.companions.length === 0) return 0;
                    return Math.round(totalExpense.value / currentTrip.value.companions.length);
                });
                const budgetPercentage = computed(() => { if (!currentTrip.value.budget || currentTrip.value.budget <= 0) return 0; return (totalExpense.value / currentTrip.value.budget) * 100; });
                const remainingBudget = computed(() => (currentTrip.value.budget || 0) - totalExpense.value);
                const budgetColor = computed(() => { const p = budgetPercentage.value; if (p >= 100) return 'bg-red-500'; if (p >= 80) return 'bg-red-400'; if (p >= 50) return 'bg-yellow-400'; return 'bg-green-400'; });
                const userStats = computed(() => {
                    const myTrips = trips.value; let totalDays = 0; const places = new Set();
                    myTrips.forEach(t => { if (t.startDate && t.endDate) { totalDays += Math.ceil(Math.abs(new Date(t.endDate) - new Date(t.startDate)) / (1000 * 60 * 60 * 24)) + 1; } if (t.destination) places.add(t.destination); });
                    return { totalTrips: myTrips.length, totalDays, uniquePlaces: places.size };
                });
                const debts = computed(() => {
                    const usersList = currentTrip.value.companions || []; if (usersList.length < 2) return [];
                    const balances = {}; usersList.forEach(u => balances[u] = 0);
                    expenses.value.forEach(exp => { const amount = Number(exp.amount); if (usersList.includes(exp.payer)) { balances[exp.payer] += amount; usersList.forEach(u => balances[u] -= amount / usersList.length); } });
                    let debtors = [], creditors = []; for (const [u, amount] of Object.entries(balances)) { if (amount < -1) debtors.push({ user: u, amount }); if (amount > 1) creditors.push({ user: u, amount }); }
                    debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);
                    const result = []; let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) { let amount = Math.min(Math.abs(debtors[i].amount), creditors[j].amount); result.push({ from: debtors[i].user, to: creditors[j].user, amount: Math.round(amount) }); debtors[i].amount += amount; creditors[j].amount -= amount; if (Math.abs(debtors[i].amount) < 1) i++; if (creditors[j].amount < 1) j++; }
                    return result;
                });

                return {
                    user, loading, loginError,
                    currentView, trips, currentTrip,
                    activeTab, days, currentDayIndex,
                    showItemModal, showTripModal, showUserMenu, showProfileModal, showDestinationModal,
                    showConfirmModal, confirmMessage, executeConfirm, confirmAction,
                    showErrorModal, errorMessage, copyToast, inviteEmail,
                    activeRegion, regions, selectDestination,
                    profileForm, tripForm, form, expenseForm,
                    schedule, expenses, settings,
                    currentDayEvents, sortedEvents, sortedExpenses, totalExpense, averageExpense, debts,
                    budgetPercentage, remainingBudget, budgetColor, userStats,
                    loginWithGoogle, copyUid,
                    onFabClick, enterTrip, exitTrip, openTripSettings, saveTrip,
                    openAddItemModal, editEvent, submitItem, deleteItem,
                    openEditProfile, saveProfile,
                    addDay, openMap, formatDate,
                    sendInvite, respondToInvite, removePending, removeCompanion, showCompanionManager, getMemberPhoto, deleteTrip, isOwner
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
