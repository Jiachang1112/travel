<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Pro ğŸŒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col w-full max-w-md mx-auto bg-gray-50 shadow-2xl relative">

        <div v-if="!user" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
            <div class="w-24 h-24 bg-gradient-to-tr from-primary to-purple-500 rounded-3xl flex items-center justify-center mb-6 shadow-xl transform rotate-3">
                <i class="fas fa-globe-americas text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Travel Pro è‡ªç”±è¡Œ</h1>
            <p class="text-gray-500 mb-10">é›²ç«¯åŒæ­¥ä½ çš„è¡Œç¨‹èˆ‡å¸³å‹™</p>
            
            <button @click="loginWithGoogle" class="flex items-center justify-center w-full bg-white border border-gray-300 rounded-xl py-3.5 px-4 shadow-sm hover:bg-gray-50 transition active:scale-95">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 mr-3" alt="Google">
                <span class="font-medium text-gray-700">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
            <p v-if="loginError" class="text-red-500 text-sm mt-4">{{ loginError }}</p>
        </div>

        <template v-else>
            
            <header class="bg-white px-5 py-3 shadow-sm z-10 flex justify-between items-center h-16 shrink-0">
                <div class="flex items-center gap-2">
                    <button v-if="currentView === 'planner'" @click="exitTrip" class="w-8 h-8 flex items-center justify-center -ml-2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div>
                        <h1 class="text-lg font-bold text-gray-800 flex items-center">
                            <span v-if="currentView === 'dashboard'">æˆ‘çš„æ—…ç¨‹ ğŸ§³</span>
                            <span v-else>{{ currentTrip.destination || 'æœªå‘½åæ—…ç¨‹' }}</span>
                            <span v-if="loading" class="ml-2 loader w-4 h-4 border-2"></span>
                        </h1>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button v-if="currentView === 'planner'" @click="openTripSettings" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:text-primary hover:bg-indigo-50 flex items-center justify-center transition">
                        <i class="fas fa-cog"></i>
                    </button>

                    <button @click="showUserMenu = true" class="relative group focus:outline-none">
                        <img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" 
                             class="w-9 h-9 rounded-full border border-gray-200 transition transform active:scale-95 object-cover">
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto no-scrollbar p-4 relative bg-gray-50">
                
                <div v-if="currentView === 'dashboard'" class="space-y-4">
                    <div v-if="trips.length === 0 && !loading" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-2xl">âœˆï¸</div>
                        <p>é‚„æ²’æœ‰ä»»ä½•æ—…ç¨‹</p>
                        <p class="text-xs mt-2">é»æ“Šå³ä¸‹è§’ã€Œ+ã€é–‹å§‹è¦åŠƒ</p>
                    </div>

                    <div v-for="trip in trips" :key="trip.id" @click="enterTrip(trip)" 
                         class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition active:scale-[0.98] cursor-pointer relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-full -mr-8 -mt-8 transition group-hover:bg-primary/10"></div>
                        
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-1">{{ trip.destination }}</h3>
                                <p v-if="trip.startDate" class="text-xs text-gray-400 mb-2 flex items-center">
                                    <i class="far fa-calendar-alt mr-1.5"></i> 
                                    {{ trip.startDate.replace(/-/g, '/') }} 
                                    <span v-if="trip.endDate" class="mx-1">~</span> 
                                    {{ trip.endDate ? trip.endDate.replace(/-/g, '/') : '' }}
                                </p>
                                <p class="text-xs text-gray-500 flex items-center gap-1">
                                    <span class="bg-gray-100 px-1.5 py-0.5 rounded font-mono">{{ trip.currency }}</span>
                                    <span v-if="trip.companions && trip.companions.length > 0">Â· {{ trip.companions.length }} äººåŒè¡Œ</span>
                                </p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 mt-2"></i>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentView === 'planner'">
                    
                    <div v-if="activeTab === 'schedule'">
                        <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6 p-2">
                            <button v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                                :class="currentDayIndex === index ? 'bg-primary text-white shadow-lg shadow-indigo-200 ring-2 ring-primary ring-offset-1' : 'bg-white text-gray-500 border border-gray-100'"
                                class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium transition-all whitespace-nowrap">
                                Day {{ index + 1 }}
                            </button>
                            <button @click="addDay" class="flex-shrink-0 w-10 flex items-center justify-center rounded-xl bg-gray-200 text-gray-500 hover:bg-gray-300">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>

                        <div v-if="currentDayEvents.length > 0" class="space-y-4 pl-2 pb-20">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-6 border-l-2 border-gray-200 last:border-transparent pb-4 group">
                                <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm z-10"></div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-primary font-bold text-lg font-mono tracking-tight">{{ event.time }}</span>
                                        <div class="flex space-x-3 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="editEvent(event)" class="text-gray-300 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                            <button @click="deleteItem('schedule', event.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-gray-800 text-lg mb-1">{{ event.title }}</h3>
                                    <div v-if="event.location" class="flex items-center text-gray-500 text-sm mb-2 cursor-pointer" @click="openMap(event.location)">
                                        <i class="fas fa-map-marker-alt mr-1.5 text-secondary"></i>
                                        <span class="truncate border-b border-dashed border-gray-300 hover:text-gray-700">{{ event.location }}</span>
                                    </div>
                                    <p v-if="event.note" class="text-gray-400 text-sm mt-2 pt-2 border-t border-gray-50 flex items-start">
                                        <i class="fas fa-info-circle mr-1.5 mt-0.5 opacity-50"></i> <span>{{ event.note }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ—“ï¸</div>
                            <p>Day {{ currentDayIndex + 1 }} é‚„æ˜¯ç©ºçš„</p>
                        </div>
                    </div>

                    <div v-else-if="activeTab === 'expense'" class="pb-20">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-xl shadow-gray-200/50 mb-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                            <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Total Expenses</p>
                            <h2 class="text-4xl font-bold font-mono tracking-tight flex items-baseline">
                                <span class="text-xl mr-1">{{ currentTrip.currency || '$' }}</span>{{ totalExpense.toLocaleString() }}
                            </h2>
                            <div class="mt-6 flex justify-between items-end">
                                <div>
                                    <p class="text-gray-400 text-xs mb-1">Average per person</p>
                                    <p class="font-mono text-lg">{{ currentTrip.currency || '$' }} {{ averageExpense.toLocaleString() }}</p>
                                </div>
                                <div class="flex -space-x-2">
                                    <div v-for="(u, i) in (currentTrip.companions || [])" :key="i" class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-800 flex items-center justify-center text-xs font-bold text-gray-300">
                                        {{ u.charAt(0) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="debts.length > 0" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 text-sm mb-3 uppercase tracking-wide">çµç®—æ–¹æ¡ˆ</h3>
                            <div class="space-y-3">
                                <div v-for="(debt, idx) in debts" :key="idx" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex items-center text-sm">
                                        <span class="font-bold text-gray-700">{{ debt.from }}</span>
                                        <i class="fas fa-long-arrow-alt-right mx-2 text-gray-400"></i>
                                        <span class="font-bold text-gray-700">{{ debt.to }}</span>
                                    </div>
                                    <span class="font-mono font-bold text-secondary">{{ currentTrip.currency || '$' }}{{ debt.amount.toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div v-for="expense in sortedExpenses" :key="expense.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center group">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary font-bold text-sm shrink-0">
                                        {{ expense.payer ? expense.payer.charAt(0) : '?' }}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 leading-tight">{{ expense.title }}</p>
                                        <p class="text-xs text-gray-400 mt-0.5">{{ formatDate(expense.date) }} Â· {{ expense.payer }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold font-mono text-gray-800">{{ currentTrip.currency || '$' }}{{ parseInt(expense.amount).toLocaleString() }}</p>
                                    <button @click="deleteItem('expenses', expense.id)" class="text-gray-300 text-xs mt-1 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <button @click="onFabClick"
                class="absolute bottom-24 right-5 w-14 h-14 bg-gray-900 text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-xl hover:scale-105 active:scale-95 transition z-40">
                <i class="fas fa-plus"></i>
            </button>

            <nav v-if="currentView === 'planner'" class="bg-white border-t border-gray-100 pb-safe pt-2 px-6 flex justify-between items-center z-30 pb-4 h-20 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
                <button @click="activeTab = 'schedule'" class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200" :class="activeTab === 'schedule' ? 'text-primary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-map-marked-alt text-xl mb-0.5 transform transition" :class="activeTab === 'schedule' ? 'scale-110' : ''"></i>
                    <span class="text-[10px] font-bold tracking-wide">è¡Œç¨‹</span>
                </button>
                <div class="w-px h-8 bg-gray-100"></div>
                <button @click="activeTab = 'expense'" class="flex flex-col items-center justify-center w-1/2 h-full space-y-1 transition duration-200" :class="activeTab === 'expense' ? 'text-secondary' : 'text-gray-300 hover:text-gray-500'">
                    <i class="fas fa-wallet text-xl mb-0.5 transform transition" :class="activeTab === 'expense' ? 'scale-110' : ''"></i>
                    <span class="text-[10px] font-bold tracking-wide">åˆ†å¸³</span>
                </button>
            </nav>

            <Transition name="slide-up">
                <div v-if="showItemModal" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-[2px]" @click.self="showItemModal = false">
                    <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[85vh] sm:h-auto flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">{{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }} {{ activeTab === 'schedule' ? 'è¡Œç¨‹' : 'æ”¯å‡º' }}</h3>
                            <button @click="showItemModal = false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar space-y-5">
                            <div v-if="activeTab === 'schedule'" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ™‚é–“</label><input v-model="form.time" type="time" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary text-lg font-mono"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ´»å‹•</label><input v-model="form.title" type="text" placeholder="ä¾‹å¦‚ï¼šé€›å¤œå¸‚" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">åœ°é»</label><div class="relative"><i class="fas fa-map-pin absolute left-4 top-4 text-gray-400"></i><input v-model="form.location" type="text" placeholder="è¼¸å…¥ Google Maps é—œéµå­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-10 outline-none focus:border-primary"></div></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å‚™è¨»</label><textarea v-model="form.note" rows="3" placeholder="ç¥¨åˆ¸è³‡è¨Š..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-primary resize-none"></textarea></div>
                            </div>
                            <div v-if="activeTab === 'expense'" class="space-y-5">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é‡‘é¡</label><div class="relative"><span class="absolute left-4 top-3.5 text-gray-400 font-bold">{{ currentTrip.currency }}</span><input v-model.number="expenseForm.amount" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 pl-8 outline-none focus:border-secondary text-2xl font-mono font-bold"></div></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é …ç›®</label><input v-model="expenseForm.title" type="text" placeholder="ä¾‹å¦‚ï¼šæ™šé¤" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 outline-none focus:border-secondary"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä»˜æ¬¾äºº</label><div class="grid grid-cols-3 gap-2"><button v-for="u in currentTrip.companions" :key="u" @click="expenseForm.payer = u" :class="expenseForm.payer === u ? 'bg-secondary text-white shadow-md shadow-pink-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="py-2.5 rounded-lg text-sm font-medium transition">{{ u }}</button></div></div>
                            </div>
                        </div>
                        <button @click="submitItem" class="w-full mt-4 py-4 rounded-2xl text-white font-bold text-lg shadow-lg active:scale-[0.98] transition flex items-center justify-center" :class="activeTab === 'schedule' ? 'bg-primary shadow-indigo-200 hover:bg-indigo-600' : 'bg-secondary shadow-pink-200 hover:bg-pink-600'">
                            <span v-if="submitting" class="loader border-white border-t-transparent w-5 h-5 mr-2"></span>{{ isEditing ? 'å„²å­˜è®Šæ›´' : 'ç¢ºèªæ–°å¢' }}
                        </button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showTripModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showTripModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">{{ currentTrip.id ? 'æ—…ç¨‹è¨­å®š' : 'å»ºç«‹æ–°æ—…ç¨‹' }}</h3>
                            <button @click="showTripModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">ç›®çš„åœ°</label>
                                <div class="relative">
                                    <input readonly @click="showDestinationModal = true" v-model="tripForm.destination" type="text" placeholder="é»æ“Šé¸æ“‡" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary cursor-pointer pr-10">
                                    <i class="fas fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ—…éŠæ—¥æœŸ</label>
                                <div class="flex items-center gap-2">
                                    <input v-model="tripForm.startDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary text-sm">
                                    <span class="text-gray-400 font-bold">-</span>
                                    <input v-model="tripForm.endDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">è²¨å¹£ç¬¦è™Ÿ</label>
                                <div class="flex gap-2">
                                    <input v-model="tripForm.currency" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                                    <button @click="tripForm.currency='NT$'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">NT$</button>
                                    <button @click="tripForm.currency='Â¥'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">Â¥</button>
                                    <button @click="tripForm.currency='$'" class="px-3 bg-gray-100 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-200">$</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">æ—…ä¼´åå–® (é€—è™Ÿåˆ†éš”)</label>
                                <input v-model="tripForm.companions" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary">
                            </div>
                        </div>
                        <button @click="saveTrip" class="w-full py-2.5 bg-gray-800 text-white rounded-xl hover:bg-gray-900 font-bold shadow-lg shadow-gray-200">å„²å­˜æ—…ç¨‹</button>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showDestinationModal" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showDestinationModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl mx-5 overflow-hidden flex flex-col max-h-[70vh]">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-800">é¸æ“‡ç›®çš„åœ°</h3>
                            <button @click="showDestinationModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex border-b border-gray-200">
                            <button v-for="key in Object.keys(regions)" :key="key" @click="activeRegion = key" :class="activeRegion === key ? 'border-primary text-primary bg-indigo-50' : 'border-transparent text-gray-500 hover:bg-gray-50'" class="flex-1 py-3 text-sm font-bold border-b-2 transition">{{ key }}</button>
                        </div>
                        <div class="p-4 overflow-y-auto grid grid-cols-2 gap-3 bg-gray-50/50 flex-1">
                            <button v-for="country in regions[activeRegion]" :key="country.name" @click="selectDestination(country)" class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:border-primary hover:shadow-md transition text-left flex items-center justify-between group">
                                <span class="font-medium text-gray-700 group-hover:text-primary">{{ country.name }}</span>
                                <span class="text-xs font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{{ country.currency }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showUserMenu" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showUserMenu = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-end mb-2">
                            <button @click="showUserMenu = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex flex-col items-center mb-6">
                             <img :src="settings.photoURL || user.photoURL || 'https://ui-avatars.com/api/?name=User'" class="w-20 h-20 rounded-full border-4 border-gray-50 shadow-md mb-3 object-cover">
                             <h3 class="text-xl font-bold text-gray-800">{{ settings.displayName || user.displayName || 'ä½¿ç”¨è€…' }}</h3>
                             <p class="text-sm text-gray-400 font-mono">{{ user.email }}</p>
                             
                             <div @click="copyUid" class="mt-2 flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full cursor-pointer hover:bg-gray-200 transition group" title="é»æ“Šè¤‡è£½ UID">
                                <span class="text-[10px] font-mono text-gray-500 break-all max-w-[200px] truncate">UID: {{ user.uid }}</span>
                                <i class="fas fa-copy text-xs text-gray-400 group-hover:text-primary"></i>
                             </div>
                             <p v-if="copyToast" class="text-xs text-green-500 font-bold mt-1 transition-all">{{ copyToast }}</p>

                        </div>
                        <div class="flex flex-col gap-3">
                            <button @click="openEditProfile" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-edit"></i> ç·¨è¼¯æª”æ¡ˆ
                            </button>
                            <button @click="showLogoutConfirm = true" class="w-full py-3 text-red-500 bg-red-50 border border-red-100 rounded-xl hover:bg-red-100 font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-sign-out-alt"></i> ç™»å‡ºå¸³è™Ÿ
                            </button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showLogoutConfirm" class="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showLogoutConfirm = false">
                    <div class="bg-white w-full max-w-[280px] rounded-2xl p-6 shadow-2xl mx-5 text-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šç™»å‡ºï¼Ÿ</h3>
                        <p class="text-sm text-gray-500 mb-6">æ‚¨ç¢ºå®šè¦ç™»å‡ºç›®å‰çš„å¸³è™Ÿå—ï¼Ÿ</p>
                        <div class="flex gap-3">
                            <button @click="showLogoutConfirm = false" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                            <button @click="confirmLogout" class="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-200">ç™»å‡º</button>
                        </div>
                    </div>
                </div>
            </Transition>

            <Transition name="fade">
                <div v-if="showProfileModal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showProfileModal = false">
                    <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl mx-5">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3>
                            <button @click="showProfileModal = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">å§“å / æš±ç¨±</label><input v-model="profileForm.displayName" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">é ­è²¼é€£çµ (URL)</label><input v-model="profileForm.photoURL" type="text" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"></div>
                        </div>
                         <button @click="saveProfile" class="w-full py-2.5 bg-primary text-white rounded-xl hover:bg-indigo-600 font-bold shadow-lg shadow-indigo-200">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </Transition>

        </template>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = {
            apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, 
            authDomain: "travel-fa395.firebaseapp.com",
            projectId: "travel-fa395",
            storageBucket: "travel-fa395.firebasestorage.app",
            messagingSenderId: "837385103808",
            appId: "1:837385103808:web:f998a17e4aeccf4b7f8025",
            measurementId: "G-31D354GWVR"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { createApp, ref, computed, watch, onMounted } = window.Vue;

        const regions = {
            'æ±': [{ name: 'æ—¥æœ¬', currency: 'Â¥' }, { name: 'éŸ“åœ‹', currency: 'â‚©' }, { name: 'å°ç£', currency: 'NT$' }, { name: 'é¦™æ¸¯', currency: 'HK$' }, { name: 'ä¸­åœ‹', currency: 'Â¥' }],
            'å—': [{ name: 'æ³°åœ‹', currency: 'à¸¿' }, { name: 'è¶Šå—', currency: 'â‚«' }, { name: 'æ–°åŠ å¡', currency: 'S$' }, { name: 'é¦¬ä¾†è¥¿äº', currency: 'RM' }, { name: 'è²å¾‹è³“', currency: 'â‚±' }, { name: 'æ¾³æ´²', currency: 'A$' }],
            'è¥¿': [{ name: 'ç¾åœ‹', currency: '$' }, { name: 'è‹±åœ‹', currency: 'Â£' }, { name: 'æ­ç›Ÿ', currency: 'â‚¬' }, { name: 'åŠ æ‹¿å¤§', currency: 'C$' }],
            'åŒ—': [{ name: 'åŒ—æµ·é“', currency: 'Â¥' }, { name: 'ä¿„ç¾…æ–¯', currency: 'â‚½' }]
        };

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const loginError = ref('');
                
                // Views: 'dashboard' (list) or 'planner' (detail)
                const currentView = ref('dashboard');
                const trips = ref([]);
                const currentTrip = ref({});
                
                // Tabs inside planner
                const activeTab = ref('schedule');
                const days = ref(['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']);
                const currentDayIndex = ref(0);
                
                // Modals
                const showItemModal = ref(false);
                const showTripModal = ref(false);
                const showUserMenu = ref(false); 
                const showProfileModal = ref(false);
                const showDestinationModal = ref(false);
                const showLogoutConfirm = ref(false);
                const copyToast = ref('');
                
                // Forms & State
                const activeRegion = ref('æ±');
                const isEditing = ref(false);
                const submitting = ref(false);
                const currentEditId = ref(null);
                
                // Data Containers
                const schedule = ref([]);
                const expenses = ref([]);
                const settings = ref({});

                // Forms Data
                const profileForm = ref({ displayName: '', photoURL: '' });
                // Updated: Added startDate and endDate
                const tripForm = ref({ destination: '', currency: '', companions: '', startDate: '', endDate: '' });
                const form = ref({ time: '10:00', title: '', location: '', note: '' });
                const expenseForm = ref({ title: '', amount: '', payer: '' });

                // Listeners
                let unsubTrips = null;
                let unsubSchedule = null;
                let unsubExpenses = null;
                let unsubSettings = null;

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); }
                    } 
                };

                onMounted(() => {
                    initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u) {
                            fetchGlobalData();
                        } else {
                            trips.value = [];
                            schedule.value = [];
                            expenses.value = [];
                        }
                    });
                });

                const loginWithGoogle = async () => {
                    try {
                        loginError.value = '';
                        if (typeof __initial_auth_token !== 'undefined') { await signInAnonymously(auth); } 
                        else { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); }
                    } catch (error) { loginError.value = "ç™»å…¥å¤±æ•—: " + error.message; }
                };

                const confirmLogout = async () => {
                    await signOut(auth);
                    showLogoutConfirm.value = false;
                    showUserMenu.value = false;
                };

                const copyUid = async () => {
                    if (user.value && user.value.uid) {
                        try {
                            await navigator.clipboard.writeText(user.value.uid);
                            copyToast.value = 'å·²è¤‡è£½!';
                            setTimeout(() => copyToast.value = '', 2000);
                        } catch (err) {
                            console.error('Failed to copy!', err);
                        }
                    }
                };

                // --- 1. Global Data (Trips List & User Settings) ---
                const fetchGlobalData = () => {
                    const settingsRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config');
                    unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                        if (docSnap.exists()) {
                            settings.value = docSnap.data();
                            if (!user.value.displayName && settings.value.displayName) user.value.displayName = settings.value.displayName;
                            if (!user.value.photoURL && settings.value.photoURL) user.value.photoURL = settings.value.photoURL;
                        }
                    });

                    const tripsRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'trips');
                    unsubTrips = onSnapshot(tripsRef, (snapshot) => {
                        trips.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                };

                // --- 2. Trip Actions ---
                const onFabClick = () => {
                    if (currentView.value === 'dashboard') {
                        // Updated: Reset startDate and endDate
                        tripForm.value = { destination: '', currency: 'Â¥', companions: user.value.displayName || 'æˆ‘', startDate: '', endDate: '' };
                        currentTrip.value = {}; 
                        showTripModal.value = true;
                    } else {
                        openAddItemModal();
                    }
                };

                const saveTrip = async () => {
                    const companionsArr = tripForm.value.companions.split(/[,ï¼Œ]/).map(u => u.trim()).filter(u => u);
                    if (!tripForm.value.destination) return alert('è«‹è¼¸å…¥ç›®çš„åœ°');
                    
                    const tripData = {
                        destination: tripForm.value.destination,
                        currency: tripForm.value.currency,
                        companions: companionsArr.length ? companionsArr : ['æˆ‘'],
                        // Updated: Save dates
                        startDate: tripForm.value.startDate,
                        endDate: tripForm.value.endDate,
                        updatedAt: new Date().toISOString()
                    };

                    try {
                        const tripsRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'trips');
                        if (currentTrip.value.id) {
                            await updateDoc(doc(tripsRef, currentTrip.value.id), tripData);
                            currentTrip.value = { ...currentTrip.value, ...tripData };
                        } else {
                            await addDoc(tripsRef, tripData);
                        }
                        showTripModal.value = false;
                    } catch (e) { alert("å„²å­˜å¤±æ•—"); }
                };

                const enterTrip = (trip) => {
                    currentTrip.value = trip;
                    currentView.value = 'planner';
                    activeTab.value = 'schedule';
                    
                    const tripDocRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'trips', trip.id);
                    
                    unsubSchedule = onSnapshot(collection(tripDocRef, 'schedule'), (snapshot) => {
                        schedule.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    unsubExpenses = onSnapshot(collection(tripDocRef, 'expenses'), (snapshot) => {
                        expenses.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                };

                const exitTrip = () => {
                    currentView.value = 'dashboard';
                    currentTrip.value = {};
                    schedule.value = [];
                    expenses.value = [];
                    if (unsubSchedule) unsubSchedule();
                    if (unsubExpenses) unsubExpenses();
                };

                const openTripSettings = () => {
                    tripForm.value = {
                        destination: currentTrip.value.destination,
                        currency: currentTrip.value.currency,
                        companions: currentTrip.value.companions.join(', '),
                        // Updated: Load existing dates
                        startDate: currentTrip.value.startDate || '',
                        endDate: currentTrip.value.endDate || ''
                    };
                    showTripModal.value = true;
                };

                // --- 3. Profile Actions ---
                const openEditProfile = () => {
                    profileForm.value = {
                        displayName: settings.value.displayName || user.value.displayName || '',
                        photoURL: settings.value.photoURL || user.value.photoURL || ''
                    };
                    showUserMenu.value = false;
                    showProfileModal.value = true;
                };

                const saveProfile = async () => {
                    if (!user.value) return;
                    try {
                        await updateProfile(user.value, {
                            displayName: profileForm.value.displayName,
                            photoURL: profileForm.value.photoURL
                        });
                        
                        const ref = doc(db, 'artifacts', appId, 'users', user.value.uid, 'settings', 'config');
                        await setDoc(ref, {
                            displayName: profileForm.value.displayName,
                            photoURL: profileForm.value.photoURL
                        }, { merge: true });

                        showProfileModal.value = false;
                    } catch (e) { alert("æ›´æ–°å¤±æ•—: " + e.message); }
                };

                // --- 4. Schedule/Expense Items Logic ---
                const openAddItemModal = () => {
                    isEditing.value = false;
                    currentEditId.value = null;
                    form.value = { time: '09:00', title: '', location: '', note: '' };
                    expenseForm.value = { title: '', amount: '', payer: currentTrip.value.companions[0] || '' };
                    showItemModal.value = true;
                };

                const editEvent = (event) => {
                    isEditing.value = true;
                    currentEditId.value = event.id;
                    form.value = { ...event };
                    showItemModal.value = true;
                };

                const submitItem = async () => {
                    submitting.value = true;
                    const tripDocRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'trips', currentTrip.value.id);
                    try {
                        if (activeTab.value === 'schedule') {
                            if (!form.value.title) throw new Error("è«‹è¼¸å…¥æ¨™é¡Œ");
                            const coll = collection(tripDocRef, 'schedule');
                            const data = { ...form.value, dayIndex: currentDayIndex.value, updatedAt: new Date().toISOString() };
                            if (isEditing.value && currentEditId.value) await updateDoc(doc(coll, currentEditId.value), data);
                            else await addDoc(coll, data);
                        } else {
                            if (!expenseForm.value.title || !expenseForm.value.amount) throw new Error("è³‡æ–™ä¸å®Œæ•´");
                            const coll = collection(tripDocRef, 'expenses');
                            const data = { ...expenseForm.value, date: new Date().toISOString() };
                            await addDoc(coll, data);
                        }
                        showItemModal.value = false;
                    } catch (e) { alert(e.message); } finally { submitting.value = false; }
                };

                const deleteItem = async (type, id) => {
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    const tripDocRef = doc(db, 'artifacts', appId, 'users', user.value.uid, 'trips', currentTrip.value.id);
                    try {
                        await deleteDoc(doc(tripDocRef, type === 'schedule' ? 'schedule' : 'expenses', id));
                    } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
                };

                // --- Helpers ---
                const selectDestination = (country) => {
                    tripForm.value.destination = country.name;
                    tripForm.value.currency = country.currency;
                    showDestinationModal.value = false;
                };
                
                const addDay = () => days.value.push(`Day ${days.value.length + 1}`);
                const openMap = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                const formatDate = (iso) => {
                    const d = new Date(iso);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                };

                // --- Computeds ---
                const currentDayEvents = computed(() => schedule.value.filter(e => e.dayIndex === currentDayIndex.value));
                const sortedEvents = computed(() => [...currentDayEvents.value].sort((a, b) => a.time.localeCompare(b.time)));
                const sortedExpenses = computed(() => [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date)));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const averageExpense = computed(() => {
                    if (!currentTrip.value.companions || currentTrip.value.companions.length === 0) return 0;
                    return Math.round(totalExpense.value / currentTrip.value.companions.length);
                });
                const debts = computed(() => {
                    const usersList = currentTrip.value.companions || [];
                    if (usersList.length < 2) return [];
                    const balances = {}; usersList.forEach(u => balances[u] = 0);
                    expenses.value.forEach(exp => {
                        const amount = Number(exp.amount);
                        if (usersList.includes(exp.payer)) {
                            const split = amount / usersList.length;
                            balances[exp.payer] += amount;
                            usersList.forEach(u => balances[u] -= split);
                        }
                    });
                    let debtors = [], creditors = [];
                    for (const [u, amount] of Object.entries(balances)) {
                        if (amount < -1) debtors.push({ user: u, amount });
                        if (amount > 1) creditors.push({ user: u, amount });
                    }
                    debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);
                    const result = []; let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i], creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                        result.push({ from: debtor.user, to: creditor.user, amount: Math.round(amount) });
                        debtor.amount += amount; creditor.amount -= amount;
                        if (Math.abs(debtor.amount) < 1) i++; if (creditor.amount < 1) j++;
                    }
                    return result;
                });

                return {
                    user, loading, loginError,
                    currentView, trips, currentTrip,
                    activeTab, days, currentDayIndex,
                    showItemModal, showTripModal, showUserMenu, showProfileModal, showDestinationModal,
                    showLogoutConfirm, copyToast,
                    activeRegion, regions, selectDestination,
                    profileForm, tripForm, form, expenseForm,
                    schedule, expenses, settings,
                    currentDayEvents, sortedEvents, sortedExpenses, totalExpense, averageExpense, debts,
                    loginWithGoogle, confirmLogout, copyUid,
                    onFabClick, enterTrip, exitTrip, openTripSettings, saveTrip,
                    openAddItemModal, editEvent, submitItem, deleteItem,
                    openEditProfile, saveProfile,
                    addDay, openMap, formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
