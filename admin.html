<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Travel Pro å¾Œå°ç®¡ç† ğŸ›¡ï¸</title>
    <link rel="icon" href="https://fav.farm/ğŸ›¡ï¸" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­å®šå…¨åŸŸè®Šæ•¸ä¾› Vue ä½¿ç”¨
        window.firebaseModules = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy };
    </script>

    <style>
        /* ç»ç’ƒè³ªæ„Ÿèˆ‡èƒŒæ™¯æ¨£å¼ (æºè‡ªä½ çš„æ—¥è¨˜æœ¬å¾Œå°) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #374151;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }
        .hover-lift { transition: all .2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12); }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>

<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto h-[calc(100vh-4rem)] flex flex-col">

        <div v-if="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
            <div class="glass-card px-8 py-6 flex items-center gap-4">
                <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <span class="font-bold text-gray-700">ç³»çµ±è¼‰å…¥ä¸­...</span>
            </div>
        </div>

        <div v-if="!authorized && !loading" class="flex-1 flex items-center justify-center">
            <div class="glass-card p-10 text-center max-w-md w-full hover-lift">
                <div class="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-shield-alt text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-extrabold text-gray-800 mb-2">Travel Pro ç®¡ç†å¾Œå°</h1>
                <p class="text-gray-500 mb-8">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ä»¥ç¹¼çºŒ</p>

                <div v-if="user && !isAdmin" class="bg-red-50 text-red-600 p-4 rounded-xl mb-6 text-sm border border-red-100">
                    <i class="fas fa-ban mr-2"></i> å¸³è™Ÿ {{ user.email }} ç„¡å­˜å–æ¬Šé™
                </div>

                <button v-if="!user" @click="login" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition shadow-lg">
                    <i class="fab fa-google mr-2"></i> Google ç™»å…¥
                </button>
                <button v-else @click="logout" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition">
                    ç™»å‡ºä¸¦åˆ‡æ›å¸³è™Ÿ
                </button>
            </div>
        </div>

        <template v-if="authorized">
            <header class="glass-card px-6 py-4 mb-6 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600">
                        <i class="fas fa-globe-americas text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl text-gray-800">Travel Pro å¾Œå°</h1>
                        <p class="text-xs text-gray-500">Admin Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <div class="text-sm font-bold text-gray-700">{{ user.displayName }}</div>
                        <div class="text-xs text-gray-400">Super Admin</div>
                    </div>
                    <img :src="user.photoURL" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                    <button @click="logout" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
                
                <div class="col-span-4 glass-card flex flex-col h-full overflow-hidden p-0">
                    <div class="p-4 border-b border-gray-100 bg-white/50 flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-gray-700">æ—…ç¨‹åˆ—è¡¨</h2>
                            <p class="text-xs text-gray-500">å…± {{ trips.length }} ç­†è³‡æ–™</p>
                        </div>
                        <button @click="fetchTrips" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition">
                            <i class="fas fa-sync-alt" :class="{'fa-spin': fetching}"></i>
                        </button>
                    </div>
                    
                    <div class="overflow-y-auto flex-1 p-3 space-y-2">
                        <div v-for="trip in trips" :key="trip.id" 
                             @click="selectTrip(trip)"
                             class="p-4 rounded-xl cursor-pointer transition border border-transparent group"
                             :class="selectedTrip?.id === trip.id ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'hover:bg-white/60 hover:border-white'">
                            
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-gray-800 truncate">{{ trip.destination }}</h3>
                                <span class="text-[10px] bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded font-mono">{{ trip.currency }}</span>
                            </div>
                            
                            <div class="text-xs text-gray-500 space-y-0.5">
                                <p><i class="far fa-calendar-alt w-4"></i> {{ trip.startDate }} ~ {{ trip.endDate }}</p>
                                <p><i class="fas fa-users w-4"></i> {{ trip.companions ? trip.companions.length : 0 }} äºº</p>
                                <p class="text-[10px] text-gray-400 mt-1 truncate">ID: {{ trip.id }}</p>
                            </div>
                        </div>

                        <div v-if="trips.length === 0 && !fetching" class="text-center py-10 text-gray-400">
                            ç„¡æ—…ç¨‹è³‡æ–™
                        </div>
                    </div>
                </div>

                <div class="col-span-8 glass-card h-full overflow-y-auto p-0 flex flex-col">
                    <div v-if="selectedTrip" class="flex-1 flex flex-col">
                        <div class="p-6 border-b border-gray-100 bg-white/30 flex justify-between items-start">
                            <div>
                                <h1 class="text-3xl font-extrabold text-gray-800 mb-2">{{ selectedTrip.destination }}</h1>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Active</span>
                                    <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold font-mono">{{ selectedTrip.id }}</span>
                                </div>
                            </div>
                            <button @click="confirmDelete(selectedTrip)" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold text-sm hover:bg-red-600 shadow-lg shadow-red-200 transition flex items-center gap-2">
                                <i class="fas fa-trash-alt"></i> å¼·åˆ¶åˆªé™¤
                            </button>
                        </div>

                        <div class="p-8 space-y-8">
                            <div class="grid grid-cols-3 gap-6">
                                <div class="bg-white/60 p-4 rounded-2xl border border-white">
                                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">é ç®—</p>
                                    <p class="text-xl font-mono font-bold text-gray-800">{{ selectedTrip.currency }}{{ selectedTrip.budget }}</p>
                                </div>
                                <div class="bg-white/60 p-4 rounded-2xl border border-white">
                                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">æ™‚é–“</p>
                                    <p class="text-sm font-bold text-gray-800">{{ selectedTrip.startDate }}</p>
                                    <p class="text-sm text-gray-500">to {{ selectedTrip.endDate }}</p>
                                </div>
                                <div class="bg-white/60 p-4 rounded-2xl border border-white">
                                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">æˆå“¡æ•¸</p>
                                    <p class="text-xl font-bold text-gray-800">{{ selectedTrip.companions?.length || 0 }}</p>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-700 mb-3">åŸå§‹è³‡æ–™ (Raw Data)</h3>
                                <div class="bg-gray-900 text-green-400 p-4 rounded-2xl font-mono text-xs overflow-x-auto shadow-inner">
                                    <pre>{{ JSON.stringify(selectedTrip, null, 2) }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-400">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-3xl">ğŸ‘ˆ</div>
                        <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹æ—…ç¨‹ä»¥æŸ¥çœ‹è©³æƒ…</p>
                    </div>
                </div>
            </div>
        </template>

    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted } = window.Vue;
        const { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } = window.firebaseModules;

        // --- Configuration (Same as Main App) ---
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = { apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, authDomain: "travel-fa395.firebaseapp.com", projectId: "travel-fa395", storageBucket: "travel-fa395.firebasestorage.app", messagingSenderId: "837385103808", appId: "1:837385103808:web:f998a17e4aeccf4b7f8025" };
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const fetching = ref(false);
                const authorized = ref(false);
                const trips = ref([]);
                const selectedTrip = ref(null);
                const adminEmail = 'bruce9811123@gmail.com';

                onMounted(() => {
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u && u.email === adminEmail) {
                            authorized.value = true;
                            fetchTrips();
                        } else {
                            authorized.value = false;
                            trips.value = [];
                            selectedTrip.value = null;
                        }
                    });
                });

                const login = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (e) {
                        alert("ç™»å…¥å¤±æ•—: " + e.message);
                    }
                };

                const logout = async () => {
                    await signOut(auth);
                    window.location.reload();
                };

                const isAdmin = computed(() => user.value && user.value.email === adminEmail);

                const fetchTrips = async () => {
                    if (!authorized.value) return;
                    fetching.value = true;
                    try {
                        // ç®¡ç†å“¡æ¨¡å¼ï¼šæŠ“å–æ‰€æœ‰æ—…ç¨‹ (éœ€æ­é… Security Rules allow read: if email == admin)
                        const q = query(collection(db, 'artifacts', appId, 'trips'), orderBy('updatedAt', 'desc'));
                        const snapshot = await getDocs(q);
                        trips.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.error(e);
                        alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase Security Rules æ˜¯å¦å·²è¨­å®šç®¡ç†å“¡æ¬Šé™ã€‚");
                    } finally {
                        fetching.value = false;
                    }
                };

                const selectTrip = (trip) => {
                    selectedTrip.value = trip;
                };

                const confirmDelete = async (trip) => {
                    if (!confirm(`è­¦å‘Šï¼šç¢ºå®šè¦å¼·åˆ¶åˆªé™¤æ—…ç¨‹ã€Œ${trip.destination}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
                    
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'trips', trip.id));
                        // æ›´æ–°åˆ—è¡¨
                        trips.value = trips.value.filter(t => t.id !== trip.id);
                        selectedTrip.value = null;
                        alert("å·²åˆªé™¤");
                    } catch (e) {
                        alert("åˆªé™¤å¤±æ•—: " + e.message);
                    }
                };

                return {
                    user, loading, fetching, authorized, isAdmin,
                    trips, selectedTrip,
                    login, logout, fetchTrips, selectTrip, confirmDelete
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
