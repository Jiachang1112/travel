<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Travel Pro å¾Œå°ç®¡ç† ğŸ›¡ï¸</title>
    <link rel="icon" href="https://fav.farm/ğŸ›¡ï¸" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­å®šå…¨åŸŸè®Šæ•¸ä¾› Vue ä½¿ç”¨
        window.firebaseModules = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, getDocs, deleteDoc, updateDoc, doc, query, orderBy };
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #374151;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }
        .hover-lift { transition: all .2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12); }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .admin-input {
            width: 100%;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 14px;
            transition: all .2s;
            font-weight: 600;
            color: #374151;
        }
        .admin-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,.12);
            background: #fff;
        }
        
        /* æœå°‹æ¡†å°ˆç”¨æ¨£å¼ */
        .search-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 8px 0;
            font-size: 0.9rem;
            color: #4b5563;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>

<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto h-[calc(100vh-4rem)] flex flex-col">

        <div v-if="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
            <div class="glass-card px-8 py-6 flex items-center gap-4">
                <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                <span class="font-bold text-gray-700">ç³»çµ±è¼‰å…¥ä¸­...</span>
            </div>
        </div>

        <div v-if="!authorized && !loading" class="flex-1 flex items-center justify-center">
            <div class="glass-card p-10 text-center max-w-md w-full hover-lift">
                <div class="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-user-shield text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-extrabold text-gray-800 mb-2">Travel Pro ç®¡ç†å¾Œå°</h1>
                <p class="text-gray-500 mb-8">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ä»¥ç®¡ç†å®¢æˆ¶è³‡æ–™</p>

                <div v-if="user && !isAdmin" class="bg-red-50 text-red-600 p-4 rounded-xl mb-6 text-sm border border-red-100">
                    <i class="fas fa-ban mr-2"></i> å¸³è™Ÿ {{ user.email }} ç„¡å­˜å–æ¬Šé™
                </div>

                <button v-if="!user" @click="login" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition shadow-lg">
                    <i class="fab fa-google mr-2"></i> Google ç™»å…¥
                </button>
                <button v-else @click="logout" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition">
                    ç™»å‡ºä¸¦åˆ‡æ›å¸³è™Ÿ
                </button>
            </div>
        </div>

        <template v-if="authorized">
            <header class="glass-card px-6 py-4 mb-6 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl text-gray-800">å¾Œå°ç®¡ç†ç³»çµ±</h1>
                        <p class="text-xs text-gray-500">è¶…ç´šç®¡ç†å“¡æ¨¡å¼ (Super Admin)</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <div class="text-sm font-bold text-gray-700">{{ user.displayName }}</div>
                        <div class="text-xs text-gray-400">{{ user.email }}</div>
                    </div>
                    <img :src="user.photoURL" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                    <button @click="logout" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
                
                <div class="col-span-4 glass-card flex flex-col h-full overflow-hidden p-0">
                    <div class="p-4 border-b border-gray-100 bg-white/50 flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-gray-700">å®¢æˆ¶æ—…ç¨‹åˆ—è¡¨</h2>
                            <p class="text-xs text-gray-500">å…± {{ filteredTrips.length }} ç­†è³‡æ–™</p>
                        </div>
                        <button @click="fetchTrips" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition">
                            <i class="fas fa-sync-alt" :class="{'fa-spin': fetching}"></i>
                        </button>
                    </div>

                    <div class="px-4 py-3 bg-white/30 border-b border-gray-100">
                        <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-3 py-1 focus-within:ring-2 focus-within:ring-indigo-100 focus-within:border-indigo-300 transition">
                            <i class="fas fa-search text-gray-400 text-sm"></i>
                            <input v-model="searchQuery" class="search-input" placeholder="æœå°‹ç›®çš„åœ° / Trip ID / User ID">
                            <button v-if="searchQuery" @click="searchQuery = ''" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto flex-1 p-3 space-y-2">
                        <div v-for="trip in filteredTrips" :key="trip.id" 
                             @click="selectTrip(trip)"
                             class="p-4 rounded-xl cursor-pointer transition border border-transparent group"
                             :class="editingTrip?.id === trip.id ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'hover:bg-white/60 hover:border-white'">
                            
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-gray-800 truncate">{{ trip.destination }}</h3>
                                <span class="text-[10px] bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded font-mono">{{ trip.currency }}</span>
                            </div>
                            
                            <div class="text-xs text-gray-500 space-y-1">
                                <p><i class="far fa-calendar-alt w-4 text-center"></i> {{ trip.startDate }}</p>
                                
                                <div class="mt-2 pt-2 border-t border-gray-200/50 flex flex-col gap-1">
                                    <p class="font-mono text-[10px] text-gray-400 flex items-center" title="Trip ID">
                                        <i class="fas fa-hashtag w-4 text-center"></i> {{ trip.id }}
                                    </p>
                                    <p class="font-mono text-[10px] text-gray-400 flex items-center" title="Owner UID">
                                        <i class="fas fa-user-shield w-4 text-center"></i> {{ trip.memberUids ? trip.memberUids[0] : 'Unknown' }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div v-if="filteredTrips.length === 0 && !fetching" class="text-center py-10 text-gray-400 text-sm">
                            {{ searchQuery ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„è³‡æ–™' : 'ç„¡æ—…ç¨‹è³‡æ–™' }}
                        </div>
                    </div>
                </div>

                <div class="col-span-8 glass-card h-full overflow-y-auto p-0 flex flex-col relative">
                    
                    <div v-if="editingTrip" class="flex-1 flex flex-col">
                        <div class="p-6 border-b border-gray-100 bg-white/30 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md">
                            <div>
                                <h2 class="text-xl font-extrabold text-gray-800">ç·¨è¼¯æ—…ç¨‹è³‡æ–™</h2>
                                <p class="text-xs text-gray-400 font-mono">ID: {{ editingTrip.id }}</p>
                            </div>
                            <div class="flex gap-3">
                                <button @click="confirmDelete" class="px-4 py-2 bg-red-50 text-red-500 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                                    <i class="fas fa-trash-alt"></i> åˆªé™¤
                                </button>
                                <button @click="saveChanges" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition flex items-center gap-2">
                                    <i class="fas fa-save" v-if="!saving"></i>
                                    <span v-else class="loader w-4 h-4 border-2 border-white border-t-transparent"></span>
                                    {{ saving ? 'å„²å­˜ä¸­...' : 'å„²å­˜è®Šæ›´' }}
                                </button>
                            </div>
                        </div>

                        <div class="p-8 space-y-8">
                            
                            <div class="bg-white/50 p-6 rounded-2xl border border-white shadow-sm">
                                <h3 class="text-sm font-bold text-indigo-600 mb-4 flex items-center gap-2">
                                    <i class="fas fa-info-circle"></i> åŸºæœ¬è³‡è¨Š
                                </h3>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="col-span-2">
                                        <label>ç›®çš„åœ° (æ¨™é¡Œ)</label>
                                        <input type="text" v-model="editingTrip.destination" class="admin-input">
                                    </div>
                                    <div>
                                        <label>é–‹å§‹æ—¥æœŸ</label>
                                        <input type="date" v-model="editingTrip.startDate" class="admin-input">
                                    </div>
                                    <div>
                                        <label>çµæŸæ—¥æœŸ</label>
                                        <input type="date" v-model="editingTrip.endDate" class="admin-input">
                                    </div>
                                    <div>
                                        <label>é ç®—ä¸Šé™</label>
                                        <input type="number" v-model.number="editingTrip.budget" class="admin-input">
                                    </div>
                                    <div>
                                        <label>è²¨å¹£å–®ä½</label>
                                        <input type="text" v-model="editingTrip.currency" class="admin-input">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white/50 p-6 rounded-2xl border border-white shadow-sm">
                                <h3 class="text-sm font-bold text-indigo-600 mb-4 flex items-center gap-2">
                                    <i class="fas fa-users"></i> æ—…ä¼´èˆ‡æ¬Šé™
                                </h3>
                                
                                <div class="mb-4">
                                    <label>æ—…ä¼´é¡¯ç¤ºåå–® (é€—è™Ÿåˆ†éš”)</label>
                                    <input type="text" :value="editingTrip.companions?.join(', ')" @input="updateCompanions" class="admin-input" placeholder="ä¾‹å¦‚: æˆ‘, å°æ˜, å°è¯">
                                    <p class="text-[10px] text-gray-400 mt-1">* é€™åªæœƒæ›´æ”¹é¡¯ç¤ºçš„åç¨±ï¼Œä¸æœƒæ›´æ”¹å¯¦éš›æ¬Šé™</p>
                                </div>

                                <div class="mb-4">
                                    <label>ç­‰å¾…åŠ å…¥çš„ Email (é€—è™Ÿåˆ†éš”)</label>
                                    <input type="text" :value="editingTrip.pendingEmails?.join(', ')" @input="updatePendingEmails" class="admin-input">
                                </div>

                                <div>
                                    <label>æ“æœ‰å­˜å–æ¬Šçš„ UID (é€²éšä¿®æ”¹)</label>
                                    <textarea v-model="rawMemberUids" rows="3" class="admin-input font-mono text-xs" placeholder='["uid1", "uid2"]'></textarea>
                                    <p class="text-[10px] text-red-400 mt-1">* è«‹å°å¿ƒä¿®æ”¹ UIDï¼ŒéŒ¯èª¤å¯èƒ½å°è‡´å®¢æˆ¶ç„¡æ³•ç™»å…¥æ—…ç¨‹</p>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">åŸå§‹è³‡æ–™é è¦½ (Read Only)</h3>
                                <div class="bg-gray-900 text-green-400 p-4 rounded-2xl font-mono text-xs overflow-x-auto shadow-inner max-h-60">
                                    <pre>{{ JSON.stringify(editingTrip, null, 2) }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-400">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-4xl">ğŸ‘ˆ</div>
                        <p class="font-bold text-gray-500">è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å®¢æˆ¶çš„æ—…ç¨‹</p>
                        <p class="text-sm mt-2">ä½ å¯ä»¥ç›´æ¥ç·¨è¼¯å…§å®¹ä¸¦å”åŠ©å®¢æˆ¶ä¿®æ­£å•é¡Œ</p>
                    </div>
                </div>
            </div>
        </template>

    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, watch } = window.Vue;
        const { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, getDocs, deleteDoc, updateDoc, doc, query, orderBy } = window.firebaseModules;

        // --- Config ---
        const secretPart = "FBLe6QQAySZGw4qv3LB8Q"; 
        const userConfig = { apiKey: "AIzaSyAl4peLsSkvm-" + secretPart, authDomain: "travel-fa395.firebaseapp.com", projectId: "travel-fa395", storageBucket: "travel-fa395.firebasestorage.app", messagingSenderId: "837385103808", appId: "1:837385103808:web:f998a17e4aeccf4b7f8025" };
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        createApp({
            setup() {
                const user = ref(null);
                const loading = ref(true);
                const fetching = ref(false);
                const saving = ref(false);
                const authorized = ref(false);
                const trips = ref([]);
                const searchQuery = ref(''); // æ–°å¢ï¼šæœå°‹é—œéµå­—
                const editingTrip = ref(null);
                const rawMemberUids = ref(''); 
                const adminEmail = 'bruce9811123@gmail.com';

                onMounted(() => {
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        loading.value = false;
                        if (u && u.email === adminEmail) {
                            authorized.value = true;
                            fetchTrips();
                        } else {
                            authorized.value = false;
                            trips.value = [];
                            editingTrip.value = null;
                        }
                    });
                });

                // æ–°å¢ï¼šéæ¿¾é‚è¼¯
                const filteredTrips = computed(() => {
                    if (!searchQuery.value) return trips.value;
                    const q = searchQuery.value.toLowerCase();
                    return trips.value.filter(t => 
                        (t.destination && t.destination.toLowerCase().includes(q)) ||
                        (t.id && t.id.toLowerCase().includes(q)) ||
                        (t.memberUids && t.memberUids.some(uid => uid.includes(q)))
                    );
                });

                const login = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (e) {
                        alert("ç™»å…¥å¤±æ•—: " + e.message);
                    }
                };

                const logout = async () => {
                    await signOut(auth);
                    window.location.reload();
                };

                const isAdmin = computed(() => user.value && user.value.email === adminEmail);

                const fetchTrips = async () => {
                    if (!authorized.value) return;
                    fetching.value = true;
                    try {
                        const q = query(collection(db, 'artifacts', appId, 'trips'), orderBy('updatedAt', 'desc'));
                        const snapshot = await getDocs(q);
                        trips.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.error(e);
                        alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase Security Rules æ˜¯å¦å·²è¨­å®šç®¡ç†å“¡æ¬Šé™ã€‚");
                    } finally {
                        fetching.value = false;
                    }
                };

                const selectTrip = (trip) => {
                    editingTrip.value = JSON.parse(JSON.stringify(trip));
                    rawMemberUids.value = JSON.stringify(trip.memberUids || []);
                };

                const updateCompanions = (e) => {
                    editingTrip.value.companions = e.target.value.split(',').map(s => s.trim()).filter(s => s);
                };

                const updatePendingEmails = (e) => {
                    editingTrip.value.pendingEmails = e.target.value.split(',').map(s => s.trim()).filter(s => s);
                };

                const saveChanges = async () => {
                    if (!editingTrip.value) return;
                    saving.value = true;
                    try {
                        try {
                            editingTrip.value.memberUids = JSON.parse(rawMemberUids.value);
                        } catch(e) {
                            alert("UID æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ˜¯æœ‰æ•ˆçš„ JSON é™£åˆ—");
                            saving.value = false;
                            return;
                        }

                        const tripRef = doc(db, 'artifacts', appId, 'trips', editingTrip.value.id);
                        const { id, ...dataToSave } = editingTrip.value;
                        dataToSave.updatedAt = new Date().toISOString(); 

                        await updateDoc(tripRef, dataToSave);
                        
                        const index = trips.value.findIndex(t => t.id === id);
                        if (index !== -1) {
                            trips.value[index] = { id, ...dataToSave };
                        }
                        alert("å„²å­˜æˆåŠŸï¼å®¢æˆ¶é‡æ–°æ•´ç†å¾Œå³å¯çœ‹åˆ°è®Šæ›´ã€‚");
                    } catch (e) {
                        console.error(e);
                        alert("å„²å­˜å¤±æ•—: " + e.message);
                    } finally {
                        saving.value = false;
                    }
                };

                const confirmDelete = async () => {
                    if (!confirm(`è­¦å‘Šï¼šç¢ºå®šè¦å¼·åˆ¶åˆªé™¤æ—…ç¨‹ã€Œ${editingTrip.value.destination}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
                    
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'trips', editingTrip.value.id));
                        trips.value = trips.value.filter(t => t.id !== editingTrip.value.id);
                        editingTrip.value = null;
                        alert("å·²åˆªé™¤");
                    } catch (e) {
                        alert("åˆªé™¤å¤±æ•—: " + e.message);
                    }
                };

                return {
                    user, loading, fetching, saving, authorized, isAdmin,
                    trips, filteredTrips, searchQuery, // æ–°å¢
                    editingTrip, rawMemberUids,
                    login, logout, fetchTrips, selectTrip, confirmDelete, saveChanges,
                    updateCompanions, updatePendingEmails
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
